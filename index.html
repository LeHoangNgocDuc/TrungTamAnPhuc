<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Thi Toán Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root { --primary: #0056b3; --success: #198754; --danger: #dc3545; }
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        
        /* === 1. NÚT TRẮC NGHIỆM A,B,C,D === */
        .opt-btn { 
            width: 45px; height: 40px; border-radius: 8px; 
            border: 2px solid #e9ecef; background: white; 
            font-weight: 700; color: #555; margin: 0 4px; transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .opt-btn:hover { background: #f8f9fa; transform: translateY(-1px); }
        
        /* Active (Được chọn) */
        .active-opt { 
            background-color: var(--primary) !important; 
            color: white !important; 
            border-color: #004085 !important; 
            box-shadow: 0 4px 10px rgba(0,86,179,0.3) !important;
            transform: translateY(-2px);
        }

        /* === 2. NÚT ĐÚNG/SAI (CẢI TIẾN MẠNH) === */
        .tf-btn {
            width: 80px; padding: 8px 0; 
            font-weight: 700; font-size: 0.9rem;
            border: 2px solid #e9ecef; 
            background: white; 
            border-radius: 8px; 
            color: #666; 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Hiệu ứng nảy */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* Khi chọn ĐÚNG -> XANH ĐẬM */
        .tf-active-d { 
            background-color: #198754 !important; 
            color: white !important; 
            border-color: #146c43 !important; 
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4) !important;
            transform: scale(1.05); 
        }

        /* Khi chọn SAI -> ĐỎ ĐẬM */
        .tf-active-s { 
            background-color: #dc3545 !important; 
            color: white !important; 
            border-color: #b02a37 !important; 
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4) !important;
            transform: scale(1.05);
        }

        /* === 3. GIAO DIỆN KẾT QUẢ (REVIEW MODE) === */
        /* Nhãn đáp án đúng (Hiện ra khi làm sai) */
        .correct-badge {
            background-color: #198754; color: white; 
            font-size: 0.8rem; font-weight: bold; 
            padding: 4px 10px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(25, 135, 84, 0.3);
            display: inline-block; white-space: nowrap;
            animation: fadeIn 0.5s;
        }
        
        /* Đánh dấu câu làm đúng/sai */
        .ans-correct-container { background-color: #d1e7dd !important; border: 1px solid #badbcc !important; }
        .ans-wrong-container { background-color: #f8d7da !important; border: 1px solid #f5c6cb !important; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Layout & Common */
        #exam-screen { display: none; height: 100vh; }
        #left-panel { height: 100%; border-right: 1px solid #ddd; padding: 0; background: #555; }
        #right-panel { height: 100%; overflow-y: auto; background: #fff; padding: 15px; }
        iframe { width: 100%; height: 100%; border: none; }
        
        .exam-card { border-radius: 12px; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .exam-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .filter-btn { border: 1px solid #ddd; background: white; color: #555; padding: 5px 15px; border-radius: 20px; margin: 3px; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="loading"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div></div>

<div id="list-screen" class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-primary fw-bold m-0"><i class="bi bi-mortarboard-fill"></i> PHÒNG THI ONLINE</h4>
        <a href="admin.html" class="btn btn-outline-secondary btn-sm">Giáo Viên</a>
    </div>

    <div class="card border-0 shadow-sm p-3 mb-4">
        <div id="class-filters" class="mb-2"></div>
        <div class="d-flex overflow-auto border-bottom mb-2 pb-2" id="type-filters" style="white-space: nowrap;">
            <button class="btn btn-sm btn-link text-decoration-none fw-bold active-type" onclick="setType('tx',this)">Thường xuyên</button>
            <button class="btn btn-sm btn-link text-decoration-none text-secondary" onclick="setType('gk1',this)">Giữa kỳ 1</button>
            <button class="btn btn-sm btn-link text-decoration-none text-secondary" onclick="setType('ck1',this)">Cuối kỳ 1</button>
            <button class="btn btn-sm btn-link text-decoration-none text-secondary" onclick="setType('gk2',this)">Giữa kỳ 2</button>
            <button class="btn btn-sm btn-link text-decoration-none text-secondary" onclick="setType('ck2',this)">Cuối kỳ 2</button>
            <button class="btn btn-sm btn-link text-decoration-none text-secondary" onclick="setType('thpt',this)">Thử THPT</button>
        </div>
        <div id="chapter-filters"></div>
    </div>

    <div id="exam-grid" class="row g-3"></div>
</div>

<div id="exam-screen" class="container-fluid">
    <div class="row h-100">
        <div class="col-lg-8 p-0" id="left-panel"><iframe id="pdf-frame"></iframe></div>
        
        <div class="col-lg-4 d-flex flex-column" id="right-panel">
            <div class="d-flex justify-content-between mb-3">
                <button onclick="location.reload()" class="btn btn-sm btn-outline-secondary">Thoát</button>
                <div class="fw-bold text-primary text-truncate" style="max-width: 200px;" id="exam-title-lbl"></div>
            </div>
            
            <div class="card bg-light border-0 mb-3 p-3 shadow-sm">
                <label class="small fw-bold text-secondary">Thông tin thí sinh:</label>
                <input id="hs-name" class="form-control form-control-sm mb-2" placeholder="Họ và Tên (Bắt buộc)">
                <input id="hs-id" class="form-control form-control-sm" placeholder="Mã Số (Bắt buộc)">
            </div>

            <div id="result-box" class="d-none mb-3">
                <div class="alert alert-success text-center p-3 shadow-sm border-0 bg-success-subtle text-success-emphasis">
                    <h1 class="fw-bold m-0 display-4" id="score-display">0.0</h1>
                    <small class="fw-bold text-uppercase ls-1">Điểm của bạn</small>
                </div>
                
                <div id="sol-link-area" class="mb-3 text-center"></div>

                <div id="rank-list" class="card p-2 small border-warning">
                    <h6 class="fw-bold border-bottom pb-2 mb-2 text-center text-warning-emphasis">
                        <i class="bi bi-trophy-fill text-warning"></i> BẢNG XẾP HẠNG
                    </h6>
                    <ul class="list-group list-group-flush" id="rank-ul">
                        <li class="list-group-item text-center text-muted fst-italic">Đang tải xếp hạng...</li>
                    </ul>
                </div>
            </div>

            <div id="questions-box" class="flex-grow-1 overflow-auto pe-2 pb-5"></div>

            <div class="mt-3 border-top pt-3 bg-white sticky-bottom" id="submit-area">
                <div id="essay-area" class="d-none mb-2">
                    <label class="small fw-bold text-primary"><i class="bi bi-camera-fill"></i> Nộp ảnh tự luận:</label>
                    <input type="file" id="essay-files" class="form-control form-control-sm" multiple accept="image/*">
                </div>
                <button onclick="submitExam()" id="btn-submit" class="btn btn-success w-100 fw-bold py-2 shadow text-uppercase">
                    <i class="bi bi-send-fill"></i> Nộp Bài Ngay
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // === LINK API ===
    const API_URL = "https://script.google.com/macros/s/AKfycbxsH2uP6wpdeWoegt2d16tT7RxY7bAgr5at4fEXSwYd7H3XF1o5yG8vBWpC85ND82s2Yg/exec"; 
    
    let allExams=[], currentFilter={class:'6',type:'tx',chapter:'1'}, currentExam=null, userAnswers={}, isReviewMode=false;

    window.onload = async () => { renderFilters(); await loadExams(); };

    // --- CÁC HÀM LỌC ĐỀ ---
    function renderFilters() {
        const cDiv = document.getElementById('class-filters');
        let h = '';
        [6,7,8,9,10,11,12].forEach(c => h+=`<button class="filter-btn ${c==6?'active':''}" onclick="setClass('${c}',this)">Lớp ${c}</button>`);
        h+=`<button class="filter-btn" onclick="setClass('TN',this)">TN THPT</button>`;
        cDiv.innerHTML = h;
        const chDiv = document.getElementById('chapter-filters');
        let ch = '';
        for(let i=1;i<=8;i++) ch+=`<button class="filter-btn small ${i==1?'active':''}" onclick="setChapter('${i}',this)">Chương ${i}</button>`;
        chDiv.innerHTML = ch;
    }
    async function loadExams() {
        try {
            const res = await fetch(API_URL + "?action=getExams&t=" + Date.now());
            const json = await res.json(); allExams = json.data; filterExams();
        } catch(e) { alert("Lỗi: "+e); }
        document.getElementById('loading').classList.add('d-none');
    }
    function filterExams() {
        const list = allExams.filter(e => e.classGrade == currentFilter.class && e.examType == currentFilter.type && (currentFilter.type!=='tx' || e.chapter == currentFilter.chapter));
        const grid = document.getElementById('exam-grid');
        grid.innerHTML = list.length ? list.map(e => `
            <div class="col-md-6 col-lg-4 col-xl-3">
                <div class="exam-card p-3 h-100 d-flex flex-column text-center border" onclick='startExam(${JSON.stringify(e).replace(/'/g,"&#39;")})'>
                    <h6 class="fw-bold text-truncate text-primary">${e.title}</h6>
                    <div class="small text-muted mb-3 flex-grow-1"><i class="bi bi-clock"></i> ${e.duration}' | ${e.totalQuestions} câu</div>
                    <button class="btn btn-outline-primary btn-sm w-100 fw-bold rounded-pill">Vào Thi</button>
                </div>
            </div>`).join('') : '<div class="col-12 text-center text-muted py-5">Không có đề thi nào.</div>';
    }
    function setClass(c, btn) { currentFilter.class=c; document.querySelectorAll('#class-filters .active').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); filterExams(); }
    function setType(t, btn) { currentFilter.type=t; document.querySelectorAll('#type-filters button').forEach(b=>{b.classList.remove('text-primary','fw-bold');b.classList.add('text-secondary')}); btn.classList.remove('text-secondary'); btn.classList.add('text-primary','fw-bold'); document.getElementById('chapter-filters').style.display=t==='tx'?'block':'none'; filterExams(); }
    function setChapter(c, btn) { currentFilter.chapter=c; document.querySelectorAll('#chapter-filters .active').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); filterExams(); }

    // --- VÀO THI ---
    function startExam(exam) {
        currentExam = exam; userAnswers = {}; isReviewMode = false;
        document.getElementById('list-screen').style.display = 'none';
        document.getElementById('exam-screen').style.display = 'block';
        document.getElementById('exam-title-lbl').innerText = exam.title;
        document.getElementById('pdf-frame').src = exam.pdfLink.replace('/view','/preview');
        
        document.getElementById('result-box').classList.add('d-none');
        document.getElementById('submit-area').classList.remove('d-none');
        document.getElementById('hs-name').disabled = false;
        document.getElementById('hs-id').disabled = false;

        renderQuestions(exam.structure);
    }

    // --- RENDER CÂU HỎI (UPDATE MỚI NHẤT) ---
    function renderQuestions(struct) {
        const qBox = document.getElementById('questions-box'); qBox.innerHTML = '';
        let cfg = (typeof struct === 'string' ? JSON.parse(struct) : struct).config || {mcq:0, tf:0, short:0};

        // 1. Trắc nghiệm
        if(cfg.mcq>0) {
            let h = `<div class="fw-bold text-primary mt-2 small border-bottom pb-1 mb-2">I. TRẮC NGHIỆM</div><div class="row g-2">`;
            for(let i=1;i<=cfg.mcq;i++) h+=`<div class="col-6 col-md-12"><div class="border rounded p-2 d-flex justify-content-between align-items-center bg-white shadow-sm" id="p1-box-${i}"><span class="fw-bold ms-2 badge bg-light text-dark border">${i}</span><div class="d-flex">${['A','B','C','D'].map(o=>`<button class="opt-btn" id="p1-c${i}-${o}" onclick="selMCQ('p1_c${i}','${o}')">${o}</button>`).join('')}</div></div></div>`;
            qBox.innerHTML+=h+'</div>';
        }
        
        // 2. Đúng Sai (NÚT ĐẬM ĐẸP NHƯ HÌNH)
        if(cfg.tf>0) {
            let h = `<div class="fw-bold text-primary mt-4 small border-bottom pb-1 mb-2">II. ĐÚNG SAI</div>`;
            for(let i=1;i<=cfg.tf;i++) h+=`
                <div class="card border-0 shadow-sm mb-3" id="p2-box-${i}">
                    <div class="card-header bg-light fw-bold small text-secondary">Câu ${i}</div>
                    <div class="card-body p-2">
                        ${['a','b','c','d'].map(s=>`
                        <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                            <span class="fw-bold ms-2 text-dark">(${s})</span>
                            <div class="d-flex gap-2">
                                <button class="tf-btn" id="p2-c${i}_${s}-D" onclick="selTF('p2_c${i}_${s}','D')">Đúng</button>
                                <button class="tf-btn" id="p2-c${i}_${s}-S" onclick="selTF('p2_c${i}_${s}','S')">Sai</button>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>`;
            qBox.innerHTML+=h;
        }
        
        // 3. Ngắn
        if(cfg.short>0) {
            let h = `<div class="fw-bold text-primary mt-4 small border-bottom pb-1 mb-2">III. TRẢ LỜI NGẮN</div><div class="row g-2">`;
            for(let i=1;i<=cfg.short;i++) h+=`<div class="col-6 col-md-12"><div class="input-group"><span class="input-group-text fw-bold bg-white">${i}</span><input class="form-control" id="p3-c${i}" placeholder="Nhập đáp án..." onblur="userAnswers['p3_c${i}']=this.value.trim()"></div></div>`;
            qBox.innerHTML+=h+'</div>';
        }
        
        if(currentExam.isEssay == true) document.getElementById('essay-area').classList.remove('d-none');
    }

    // --- LOGIC CHỌN (HIỆU ỨNG ĐẬM ĐÀ) ---
    function selMCQ(k,v) { 
        if(isReviewMode) return;
        userAnswers[k]=v; 
        ['A','B','C','D'].forEach(o=>document.getElementById(k.replace('_','-')+'-'+o).classList.remove('active-opt')); 
        document.getElementById(k.replace('_','-')+'-'+v).classList.add('active-opt'); 
    }
    
    function selTF(k,v) { 
        if(isReviewMode) return;
        userAnswers[k]=v; 
        const base = k.replace(/_/g,'-');
        
        const btnD = document.getElementById(base+'-D');
        const btnS = document.getElementById(base+'-S');
        
        // Reset Style
        btnD.classList.remove('tf-active-d');
        btnS.classList.remove('tf-active-s');
        
        // Apply New Style (Xanh hoặc Đỏ)
        if(v==='D') btnD.classList.add('tf-active-d');
        else btnS.classList.add('tf-active-s');
    }

    // --- NỘP BÀI ---
    async function submitExam() {
        const hs = document.getElementById('hs-name').value;
        const id = document.getElementById('hs-id').value;
        if(!hs || !id) return alert("Vui lòng nhập Họ tên và Mã HS!");
        if(!confirm("Bạn có chắc chắn muốn nộp bài?")) return;
        
        document.getElementById('loading').classList.remove('d-none');

        // Logic tính điểm
        let struct = typeof currentExam.structure==='string'?JSON.parse(currentExam.structure):currentExam.structure;
        let key = struct.answers || {};
        let config = struct.config || {};
        
        let scoreP1=0, scoreP2=0, scoreP3=0;
        let maxP1 = config.scoreP1 || 3.0; 
        let maxP3 = config.scoreP3 || 3.0; 
        
        // P1
        let countP1 = 0;
        for(let i=1; i<=config.mcq; i++) { if(userAnswers[`p1_c${i}`] === key[`p1_c${i}`]) countP1++; }
        if(config.mcq>0) scoreP1 = (maxP1/config.mcq)*countP1;

        // P3
        let countP3 = 0;
        for(let i=1; i<=config.short; i++) {
            let u = (userAnswers[`p3_c${i}`]||"").toUpperCase().replace(/\s/g,'');
            let k = (key[`p3_c${i}`]||"").toUpperCase().replace(/\s/g,'');
            if(u===k && k!=="") countP3++;
        }
        if(config.short>0) scoreP3 = (maxP3/config.short)*countP3;

        // P2 (Quy tắc 0.1 - 0.25 - 0.5 - 1.0)
        for(let i=1; i<=config.tf; i++) {
            let c=0;
            ['a','b','c','d'].forEach(s=>{ if(userAnswers[`p2_c${i}_${s}`] === key[`p2_c${i}_${s}`]) c++; });
            if(c==1) scoreP2+=0.1; else if(c==2) scoreP2+=0.25; else if(c==3) scoreP2+=0.5; else if(c==4) scoreP2+=1.0;
        }

        let total = (scoreP1+scoreP2+scoreP3).toFixed(2);
        if(total>10) total=10;

        let imgs = []; const files = document.getElementById('essay-files').files;
        if(files.length) {
            const toB64=f=>new Promise((r,j)=>{const fr=new FileReader();fr.readAsDataURL(f);fr.onload=()=>r(fr.result);fr.onerror=j});
            for(let f of files) imgs.push(await toB64(f));
        }

        await fetch(API_URL, {method:'POST', body:JSON.stringify({
            action:'submitExam', maHS:id, tenHS:hs, maDe:currentExam.id, 
            score:total, studentAnswers:userAnswers, detailResult:{}, images:imgs
        })});

        const rankRes = await fetch(API_URL + `?action=getRankings&maDe=${currentExam.id}`);
        const rankJson = await rankRes.json();
        
        showResult(total, rankJson.data, key, config);
        document.getElementById('loading').classList.add('d-none');
    }

    // --- HIỂN THỊ KẾT QUẢ & REVIEW ---
    function showResult(score, ranks, key, config) {
        isReviewMode = true;
        document.getElementById('submit-area').classList.add('d-none');
        document.getElementById('result-box').classList.remove('d-none');
        document.getElementById('score-display').innerText = score;
        
        document.getElementById('hs-name').disabled = true;
        document.getElementById('hs-id').disabled = true;

        const rankUl = document.getElementById('rank-ul'); rankUl.innerHTML = '';
        ranks.forEach((r, i) => {
            let cls = i===0?'rank-1':(i===1?'rank-2':(i===2?'rank-3':''));
            rankUl.innerHTML += `<li class="list-group-item d-flex justify-content-between py-1"><span>${i+1}. ${r.tenHS}</span> <span class="${cls}">${r.diem}</span></li>`;
        });

        // Link đáp án: LUÔN HIỆN VÀ MỞ TAB MỚI
        if(currentExam.solutionLink) {
            let finalLink = currentExam.solutionLink.replace(/\/view.*/, '/preview');
            document.getElementById('sol-link-area').innerHTML = `
                <a href="${finalLink}" target="_blank" class="btn btn-primary w-100 fw-bold shadow py-2 text-uppercase">
                    <i class="bi bi-file-earmark-check-fill"></i> Xem Lời Giải Chi Tiết
                </a>`;
        }

        // --- TÔ MÀU ĐÁP ÁN (QUAN TRỌNG) ---
        
        // P1: Trắc nghiệm
        for(let i=1; i<=config.mcq; i++) {
            let u = userAnswers[`p1_c${i}`];
            let k = key[`p1_c${i}`];
            let box = document.getElementById(`p1-box-${i}`);
            
            ['A','B','C','D'].forEach(o=>document.getElementById(`p1-c${i}-${o}`).disabled=true);

            if(u===k) { 
                box.classList.add('ans-correct-container');
            } else {
                box.classList.add('ans-wrong-container');
                // HIỆN NHÃN ĐÁP ÁN ĐÚNG
                box.innerHTML += `<span class="correct-badge ms-auto">ĐA: ${k}</span>`;
            }
        }

        // P2: Đúng Sai
        for(let i=1; i<=config.tf; i++) {
            ['a','b','c','d'].forEach(s => {
                let u = userAnswers[`p2_c${i}_${s}`];
                let k = key[`p2_c${i}_${s}`];
                let btnD = document.getElementById(`p2-c${i}_${s}-D`);
                let btnS = document.getElementById(`p2-c${i}_${s}-S`);
                
                btnD.disabled=true; btnS.disabled=true;

                if(u !== k) {
                    // Nếu sai -> Hiện đáp án đúng bên cạnh
                    let parent = btnS.parentNode.parentNode; // Lấy thẻ div cha
                    parent.innerHTML += `<span class="correct-badge ms-2">${k==='D'?'ĐÚNG':'SAI'}</span>`;
                    
                    // Làm mờ lựa chọn sai
                    if(u==='D') btnD.style.opacity = 0.5;
                    if(u==='S') btnS.style.opacity = 0.5;
                }
            });
        }

        // P3: Ngắn
        for(let i=1; i<=config.short; i++) {
            let inp = document.getElementById(`p3-c${i}`);
            let u = (inp.value||"").toUpperCase();
            let k = (key[`p3_c${i}`]||"").toUpperCase();
            inp.disabled = true;
            if(u===k) inp.classList.add('is-valid');
            else {
                inp.classList.add('is-invalid');
                let div = document.createElement('div');
                div.className = "text-success small fw-bold mt-1";
                div.innerText = `Đáp án đúng: ${k}`;
                inp.parentNode.appendChild(div);
            }
        }
        
        // Scroll lên đầu để xem điểm
        document.getElementById('right-panel').scrollTop = 0;
    }
</script>
</body>
</html>