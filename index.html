<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thi Online Mobile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root { --primary: #0d6efd; --success: #198754; --danger: #dc3545; }
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 70px; -webkit-tap-highlight-color: transparent; }
        
        /* === 1. TRẮC NGHIỆM (1 DÒNG) === */
        .mcq-row { display: flex; justify-content: space-between; gap: 10px; margin-top: 15px; }
        .opt-btn { 
            flex: 1; height: 50px; border-radius: 8px; 
            border: 2px solid #dee2e6; background: white; 
            font-weight: 700; color: #555; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .active-opt { 
            background-color: var(--primary) !important; color: white !important; 
            border-color: #004085 !important; box-shadow: 0 4px 8px rgba(13,110,253,0.3);
            transform: translateY(-2px);
        }

        /* === 2. ĐÚNG SAI (2 DÒNG - 2 CỘT) === */
        .tf-grid-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tf-item { background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 8px; }
        .tf-label { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; display: block; }
        .tf-options { display: flex; gap: 5px; }
        .tf-btn { 
            flex: 1; padding: 6px 0; font-weight: 700; font-size: 0.85rem;
            border: 1px solid #ced4da; background: #f8f9fa; border-radius: 6px; color: #666;
        }
        .tf-active-d { background: var(--success) !important; color: white !important; border-color: var(--success) !important; }
        .tf-active-s { background: var(--danger) !important; color: white !important; border-color: var(--danger) !important; }

        /* === 3. TRẢ LỜI NGẮN & UTILS === */
        #exam-timer { font-family: 'Courier New', monospace; font-size: 1.2rem; font-weight: 900; color: #dc3545; }
        
        /* Layout */
        #exam-screen { display: none; height: 100vh; flex-direction: column; }
        #pdf-frame { flex: 1; width: 100%; border: none; background: #eee; }
        /* Phần trả lời phía dưới */
        #answer-sheet { 
            height: 55vh; overflow-y: auto; background: white; padding: 15px; 
            border-top: 4px solid var(--primary); 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); 
        }

        /* Nav Bar */
        #nav-bar-fixed {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; 
            padding: 10px 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000;
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        .nav-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: #f0f2f5; color: #333; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }
        
        /* Review Mode */
        .review-wrong { border: 2px solid red !important; opacity: 0.6; }
        .review-correct { border: 2px solid green !important; }
        .correct-badge { font-size: 0.7rem; background: green; color: white; padding: 2px 5px; border-radius: 4px; margin-left: 5px; }

        /* Loading */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* Card Filter (Home) */
        .filter-section { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .exam-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
    </style>
</head>
<body>

<div id="loading"><div class="spinner-border text-primary"></div><div class="mt-2 fw-bold text-secondary">Đang tải...</div></div>

<div id="home-screen" class="container py-3">
    <h5 class="fw-bold text-primary mb-3">THI TRỰC TUYẾN</h5>
    
    <div class="filter-section">
        <div class="row g-2 mb-2">
            <div class="col-4">
                <select id="sel-grade" class="form-select form-select-sm" onchange="updateClassAndFilter()">
                    <option value="6">Khối 6</option><option value="7">Khối 7</option>
                    <option value="8">Khối 8</option><option value="9">Khối 9</option>
                    <option value="10">Khối 10</option><option value="11">Khối 11</option><option value="12">Khối 12</option>
                </select>
            </div>
            <div class="col-4">
                <select id="sel-class" class="form-select form-select-sm" onchange="loadStudents()">
                    <option value="">Lớp</option>
                </select>
            </div>
            <div class="col-4">
                <a href="admin.html" class="btn btn-sm btn-outline-secondary w-100">Giáo viên</a>
            </div>
        </div>
        <select id="sel-student" class="form-select form-select-sm" disabled>
            <option value="">-- Chọn tên học sinh --</option>
        </select>
    </div>

    <div style="overflow-x:auto; white-space:nowrap; padding-bottom:5px" class="mb-3">
        <button class="btn btn-sm btn-primary rounded-pill me-1" onclick="setType('tx')">Thường xuyên</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill me-1" onclick="setType('gk1')">Giữa kỳ 1</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill me-1" onclick="setType('ck1')">Cuối kỳ 1</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill me-1" onclick="setType('gk2')">Giữa kỳ 2</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="setType('ck2')">Cuối kỳ 2</button>
    </div>
    <div id="chapter-filters" class="mb-3"></div>
    <div id="exam-grid"></div>
</div>

<div id="exam-screen">
    <div style="height: 45vh; position: relative;">
        <iframe id="pdf-frame" style="width:100%; height:100%; border:none;"></iframe>
        <div class="position-absolute top-0 end-0 m-2 bg-white px-2 py-1 rounded shadow border border-danger">
            <i class="bi bi-clock-history text-danger"></i> <span id="exam-timer">90:00</span>
        </div>
        <button onclick="if(confirm('Thoát?')) location.reload()" class="btn btn-sm btn-light position-absolute top-0 start-0 m-2 shadow"><i class="bi bi-arrow-left"></i></button>
    </div>

    <div id="answer-sheet">
        <div id="result-box" class="d-none text-center mb-4">
            <h1 class="display-3 fw-bold text-success mb-0" id="score-display">--</h1>
            <small class="fw-bold">ĐIỂM SỐ</small>
            <div id="sol-link-area" class="mt-2"></div>
            <button onclick="location.reload()" class="btn btn-outline-secondary w-100 mt-3 rounded-pill">Thoát</button>
        </div>

        <div id="question-content"></div>
    </div>

    <div id="nav-bar-fixed">
        <button class="nav-btn" onclick="prevQ()"><i class="bi bi-chevron-left"></i></button>
        <div class="d-flex align-items-center gap-2">
            <span>Câu</span>
            <input type="number" id="jump-input" value="1" min="1" class="form-control text-center fw-bold p-1" style="width: 50px;" onchange="jumpQ()">
            <span class="text-muted" id="total-q">/ --</span>
        </div>
        <button class="nav-btn" onclick="nextQ()"><i class="bi bi-chevron-right"></i></button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxvNZw8PGyVAcLU8Kas8JKvFBh6lcYRKJ05iDw2WUw3KV1bzfMEDPpmBwKrA9U9IFiqsA/exec"; // THAY LINK CỦA BẠN
    
    let allExams=[], currentFilter={class:'6',type:'tx',chapter:'1'};
    let currentExam=null, userAnswers={}, questionMap=[], qIdx=0;
    let studentInfo={id:'', name:''}, timerInterval;

    // --- KHỞI TẠO ---
    window.onload = async () => {
        updateClassAndFilter();
        renderChapters();
        await fetchExams();
    };

    // --- 1. LOGIC LỚP & ĐỀ ---
    function updateClassAndFilter() {
        const grade = document.getElementById('sel-grade').value;
        const clsSel = document.getElementById('sel-class');
        clsSel.innerHTML = '<option value="">-Chọn-</option>';
        let letters = (grade <= 9) ? ['A','B','C','D','E'] : ['A','B'];
        letters.forEach(L => clsSel.innerHTML += `<option value="${grade}${L}">${grade}${L}</option>`);
        currentFilter.class = grade;
        filterExams();
    }

    async function loadStudents() {
        const cls = document.getElementById('sel-class').value;
        const stuSel = document.getElementById('sel-student');
        if(!cls) { stuSel.disabled=true; return; }
        stuSel.disabled=true; stuSel.innerHTML='<option>Đang tải...</option>';
        try {
            const res = await fetch(API_URL + `?action=getStudentsByClass&className=${cls}`);
            const json = await res.json();
            stuSel.innerHTML = '<option value="">-- Chọn tên học sinh --</option>';
            if(json.data) json.data.forEach(s => stuSel.innerHTML += `<option value="${s.id}|${s.name}">${s.name}</option>`);
            stuSel.disabled=false;
        } catch(e) { stuSel.innerHTML='<option>Lỗi tải</option>'; }
    }

    async function fetchExams() {
        try {
            const res = await fetch(API_URL + "?action=getExams&t=" + Date.now());
            const json = await res.json();
            allExams = json.data || [];
            filterExams();
        } catch(e) {}
        document.getElementById('loading').style.display='none';
    }

    function filterExams() {
        const list = allExams.filter(e => e.classGrade == currentFilter.class && e.examType == currentFilter.type && (currentFilter.type!=='tx' || e.chapter == currentFilter.chapter));
        const grid = document.getElementById('exam-grid');
        if(list.length===0) { grid.innerHTML='<div class="text-center text-muted py-4">Không có đề thi.</div>'; return; }
        grid.innerHTML = list.map(e => `
            <div class="exam-card" onclick='preStart(${JSON.stringify(e).replace(/'/g,"&#39;")})'>
                <div class="fw-bold text-primary text-truncate">${e.title}</div>
                <div class="small text-muted mt-1">${e.duration} phút • ${e.totalQuestions} câu</div>
            </div>`).join('');
    }

    function setType(t) { currentFilter.type=t; document.getElementById('chapter-filters').style.display=t==='tx'?'block':'none'; filterExams(); }
    function renderChapters() { let h=''; for(let i=1;i<=8;i++) h+=`<button class="btn btn-sm btn-outline-dark me-1" style="font-size:0.75rem" onclick="currentFilter.chapter='${i}';filterExams()">Chương ${i}</button>`; document.getElementById('chapter-filters').innerHTML=h; }

    // --- 2. VÀO THI ---
    function preStart(exam) {
        const val = document.getElementById('sel-student').value;
        if(!val || val.includes("Chọn")) return alert("Vui lòng chọn Tên Học Sinh!");
        const [id, name] = val.split('|'); studentInfo = {id, name};
        startExam(exam);
    }

    function startExam(exam) {
        currentExam = exam; userAnswers = {}; qIdx = 0; questionMap = [];
        
        let struct = (typeof exam.structure==='string')?JSON.parse(exam.structure):exam.structure;
        let c = struct.config || {mcq:0, tf:0, short:0};
        
        for(let i=1; i<=c.mcq; i++) questionMap.push({type:'mcq', id:i, lbl:`Câu ${i}`});
        for(let i=1; i<=c.tf; i++) questionMap.push({type:'tf', id:i, lbl:`Câu ${i}`});
        for(let i=1; i<=c.short; i++) questionMap.push({type:'sh', id:i, lbl:`Câu ${i}`});

        document.getElementById('home-screen').classList.add('d-none');
        document.getElementById('exam-screen').style.display = 'flex';
        document.getElementById('pdf-frame').src = exam.pdfLink.replace('/view','/preview');
        document.getElementById('total-q').innerText = "/ " + questionMap.length;
        document.getElementById('jump-input').max = questionMap.length;

        // BẮT ĐẦU ĐỒNG HỒ
        startTimer(exam.duration);
        renderQ(0);
    }

    function startTimer(minutes) {
        let time = minutes * 60;
        const display = document.getElementById('exam-timer');
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            let m = Math.floor(time / 60);
            let s = time % 60;
            display.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (time <= 0) {
                clearInterval(timerInterval);
                alert("Hết giờ làm bài!");
                submitExam(true); // Auto submit
            }
            time--;
        }, 1000);
    }

    // --- 3. RENDER 1 CÂU HỎI (LAYOUT TỐI ƯU) ---
    function renderQ(idx) {
        if(idx<0 || idx>=questionMap.length) return;
        qIdx = idx;
        document.getElementById('jump-input').value = idx + 1;
        
        const q = questionMap[idx];
        const box = document.getElementById('question-content');
        let h = `<h6 class="fw-bold text-primary mb-3">${q.lbl}</h6>`;

        // TRẮC NGHIỆM: 1 DÒNG A, B, C, D
        if(q.type === 'mcq') {
            h += `<div class="mcq-row">`;
            ['A','B','C','D'].forEach(o => {
                let active = userAnswers[`p1_c${q.id}`]===o ? 'active-opt' : '';
                h += `<div class="opt-btn ${active}" onclick="ans('p1_c${q.id}', '${o}')">${o}</div>`;
            });
            h += `</div>`;
        } 
        // ĐÚNG SAI: LƯỚI 2 CỘT
        else if (q.type === 'tf') {
            h += `<div class="tf-grid-wrapper">`;
            ['a','b','c','d'].forEach(s => {
                let u = userAnswers[`p2_c${q.id}_${s}`];
                h += `
                <div class="tf-item">
                    <span class="tf-label">Ý (${s})</span>
                    <div class="tf-options">
                        <div class="tf-btn ${u==='D'?'tf-active-d':''}" onclick="ans('p2_c${q.id}_${s}','D')">Đ</div>
                        <div class="tf-btn ${u==='S'?'tf-active-s':''}" onclick="ans('p2_c${q.id}_${s}','S')">S</div>
                    </div>
                </div>`;
            });
            h += `</div>`;
        }
        // TRẢ LỜI NGẮN: INPUT KHÔNG RELOAD
        else {
            // Quan trọng: oninput chỉ lưu biến, không gọi renderQ lại để tránh mất bàn phím
            let val = userAnswers[`p3_c${q.id}`] || '';
            h += `<input type="text" class="form-control form-control-lg text-center fw-bold mt-2" 
                   placeholder="Nhập kết quả..." value="${val}" 
                   oninput="userAnswers['p3_c${q.id}'] = this.value.trim()">`;
        }
        
        // Thêm nút Nộp bài ở cuối câu hỏi cuối cùng
        if(idx === questionMap.length - 1) {
            h += `<button onclick="submitExam()" class="btn btn-success w-100 mt-4 fw-bold py-3 shadow">NỘP BÀI</button>`;
        }

        box.innerHTML = h;
    }

    function ans(k, v) { userAnswers[k] = v; renderQ(qIdx); }
    function prevQ() { renderQ(qIdx-1); }
    function nextQ() { renderQ(qIdx+1); }
    function jumpQ() { renderQ(parseInt(document.getElementById('jump-input').value)-1); }

    // --- 4. NỘP BÀI ---
    async function submitExam(auto=false) {
        if(!auto && !confirm("Bạn có chắc chắn NỘP BÀI?")) return;
        clearInterval(timerInterval);
        document.getElementById('loading').style.display = 'flex';

        // Tính điểm
        let st = (typeof currentExam.structure==='string')?JSON.parse(currentExam.structure):currentExam.structure;
        let k = st.answers||{}; let cf = st.config||{};
        let s1=0, s2=0, s3=0;

        // P1
        let c1=0; for(let i=1; i<=cf.mcq; i++) if(userAnswers[`p1_c${i}`]===k[`p1_c${i}`]) c1++;
        if(cf.mcq>0) s1 = (3.0/cf.mcq)*c1;
        // P3
        let c3=0; for(let i=1; i<=cf.short; i++) {
            let u=(userAnswers[`p3_c${i}`]||"").toUpperCase().trim(); let key=(k[`p3_c${i}`]||"").toUpperCase().trim();
            if(u===key && key!=="") c3++;
        }
        if(cf.short>0) s3 = (3.0/cf.short)*c3;
        // P2
        for(let i=1; i<=cf.tf; i++) {
            let c=0; ['a','b','c','d'].forEach(s=>{ if(userAnswers[`p2_c${i}_${s}`]===k[`p2_c${i}_${s}`]) c++; });
            if(c==1)s2+=0.1; else if(c==2)s2+=0.25; else if(c==3)s2+=0.5; else if(c==4)s2+=1.0;
        }
        
        let total = (s1+s2+s3).toFixed(2); if(total>10) total=10;

        // Gửi kết quả
        await fetch(API_URL, {method:'POST', body:JSON.stringify({
            action:'submitExam', maHS:studentInfo.id, tenHS:studentInfo.name, maDe:currentExam.id,
            score:total, studentAnswers:userAnswers, detailResult:{}
        })});

        // Hiện kết quả
        document.getElementById('question-content').innerHTML='';
        document.getElementById('nav-bar-fixed').style.display='none';
        document.getElementById('result-box').classList.remove('d-none');
        document.getElementById('score-display').innerText = total;
        
        if(currentExam.solutionLink) {
            let l = currentExam.solutionLink.replace('/view','/preview');
            document.getElementById('sol-link-area').innerHTML = `<a href="${l}" target="_blank" class="btn btn-primary w-100 py-3 fw-bold">XEM LỜI GIẢI</a>`;
        }

        document.getElementById('loading').style.display = 'none';
    }
</script>
</body>
</html>