<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trung Tâm Toán An Phúc Education</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root { --header-blue: #0d6efd; --nav-bg: #212529; --highlight-red: #dc3545; --primary: #0d6efd; --success: #198754; --danger: #dc3545; }
        body { background: #f4f6f9; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .main-header { background: linear-gradient(90deg, #0056b3 0%, #0d6efd 100%); color: white; padding: 10px 0; flex-shrink: 0; }
        .logo-img { width: 65px; height: 65px; object-fit: contain; background: white; border-radius: 50%; padding: 2px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .header-title { font-weight: 800; text-transform: uppercase; font-size: 1.1rem; line-height: 1.1; }
        .header-slogan { font-size: 0.8rem; font-style: italic; opacity: 0.9; }
        .main-nav { background: var(--nav-bg); padding: 0; flex-shrink: 0; }
        .nav-item-custom { color: white; padding: 10px 15px; text-decoration: none; font-weight: 600; font-size: 0.9rem; display: inline-block; }
        .nav-item-custom:hover { background: #343a40; color: #fff; }
        .nav-active-red { background: var(--highlight-red); color: white !important; }
        #home-screen { height: calc(100vh - 130px); overflow-y: auto; padding: 15px; background: #f4f6f9; }
        .grade-pill { border: 1px solid #ddd; background: white; color: #555; padding: 5px 12px; border-radius: 20px; font-weight: 600; margin: 0 2px; cursor: pointer; }
        .grade-pill.active { background: var(--header-blue); color: white; border-color: var(--header-blue); }
        .type-tab { padding: 8px 12px; cursor: pointer; color: #666; font-weight: 600; white-space: nowrap; border-bottom: 3px solid transparent; }
        .type-tab.active { color: var(--header-blue); border-bottom-color: var(--header-blue); }
        .exam-card { background: white; border-radius: 10px; padding: 15px; border-left: 4px solid var(--header-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; cursor: pointer; }
        #exam-screen { display: none; height: 100vh; flex-direction: column; background: white; position: fixed; top: 0; left: 0; width: 100%; z-index: 2000; }
        .exam-header-bar { height: 50px; flex-shrink: 0; background: white; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; }
        .timer-box { background: #dc3545; color: white; font-weight: 900; font-family: 'Courier New', monospace; padding: 5px 15px; border-radius: 8px; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(220, 53, 69, 0.4); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        .pdf-container { height: 60vh; flex-shrink: 0; background: #525659; border-bottom: 5px solid #666; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }
        .qa-container { flex: 1; overflow-y: auto; background: #fff; padding: 15px; padding-bottom: 70px; position: relative; }
        .mcq-row { display: flex; gap: 8px; margin-top: 10px; }
        .opt-btn { flex: 1; height: 50px; border-radius: 8px; border: 2px solid #e9ecef; background: white; font-weight: 700; color: #555; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; }
        .active-opt { background: var(--header-blue); color: white; border-color: var(--header-blue); box-shadow: 0 3px 8px rgba(13,110,253,0.3); transform: translateY(-2px); }
        .tf-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .tf-item { background: #f8f9fa; border: 1px solid #eee; padding: 8px; border-radius: 8px; }
        .tf-btn { width: 100%; padding: 6px 0; margin-top: 4px; font-weight: bold; border: 1px solid #ccc; background: white; border-radius: 6px; font-size: 0.85rem; }
        .tf-active-d { background: var(--success); color: white; border-color: var(--success); }
        .tf-active-s { background: var(--danger); color: white; border-color: var(--danger); }
        .nav-bottom { position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; background: white; border-top: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 30; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-circle { width: 45px; height: 45px; border-radius: 50%; background: #f1f3f5; border: none; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: #333; }
        #overview-screen { position: absolute; top: 50px; left: 0; width: 100%; height: calc(100% - 50px); background: #f8f9fa; z-index: 3000; display: none; padding: 15px; overflow-y: auto; flex-direction: column; }
        .part-header { background: #e9ecef; padding: 10px; font-weight: 800; font-size: 0.95rem; border-radius: 6px; margin: 20px 0 10px 0; color: var(--header-blue); border-left: 5px solid var(--header-blue); }
        .grid-mcq { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; }
        .grid-tf { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .grid-short { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .q-cell { border-radius: 8px; border: 1px solid #ddd; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; color: #555; position: relative; padding: 5px; }
        .q-done { border-color: var(--success); background: #e8f5e9; color: var(--success); font-weight: bold; }
        .q-cell-ans { font-size: 0.85rem; color: var(--header-blue); font-weight: bold; margin-top: 2px; }
        .tf-summary-row { display: flex; align-items: center; justify-content: space-between; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; }
        .tf-badges { display: flex; gap: 5px; }
        .tf-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; background: #eee; color: #aaa; font-weight: bold; }
        .tf-badge.done { background: var(--success); color: white; border-color: var(--success); }
        .tf-badge.false { background: var(--danger); color: white; border-color: var(--danger); }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading"><div class="spinner-border text-primary"></div><p class="mt-2 fw-bold text-secondary">Đang tải...</p></div>

<div class="modal fade" id="historyModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning"><h5 class="modal-title fw-bold text-dark">THÔNG BÁO</h5></div>
      <div class="modal-body text-center">
        <p class="mb-1">Bạn đã làm bài này <b class="text-danger fs-5" id="his-count">0</b> lần.</p>
        <p class="small text-muted">Điểm lần cuối: <b id="his-score">--</b>. Bạn muốn?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-outline-secondary fw-bold" onclick="startExam(true)">LÀM LẠI</button>
        <button class="btn btn-primary fw-bold" onclick="reviewOldExam()">XEM BÀI CŨ</button>
      </div>
    </div>
  </div>
</div>

<header>
    <div class="main-header">
        <div class="container d-flex align-items-center ps-3 pe-3">
            <img src="./Logo.jpg" alt="Logo" class="logo-img me-3">
            <div><div class="header-title">TOÁN AN PHÚC EDUCATION</div><div class="header-slogan">"Vững kiến thức - Chắc tương lai"</div></div>
        </div>
    </div>
    <div class="main-nav">
        <div class="d-flex overflow-auto ps-2 pe-2" style="white-space: nowrap;">
            <a href="#" class="nav-item-custom"><i class="bi bi-house-door-fill"></i> Trang chủ</a>
            <a href="#" class="nav-item-custom">Toán 6-9</a>
            <a href="#" class="nav-item-custom">Toán 10-12</a>
            <a href="#" class="nav-item-custom nav-active-red">THI TRỰC TUYẾN</a>
        </div>
    </div>
</header>

<div id="home-screen">
    <div class="card p-3 mb-3 border bg-white shadow-sm">
        <h6 class="fw-bold text-dark border-bottom pb-2 mb-3">Thông tin thí sinh</h6>
        <div class="row g-2 mb-2">
            <div class="col-4"><select id="sel-grade" class="form-select form-select-sm" onchange="updateClassAndFilter()"><option value="6">K.6</option><option value="7">K.7</option><option value="8">K.8</option><option value="9">K.9</option><option value="10">K.10</option><option value="11">K.11</option><option value="12">K.12</option></select></div>
            <div class="col-4"><select id="sel-class" class="form-select form-select-sm" onchange="loadStudents()"><option value="">- Lớp -</option></select></div>
            <div class="col-4"><select id="sel-student" class="form-select form-select-sm" disabled><option value="">-- Tên --</option></select></div>
        </div>
        <div class="text-end"><a href="admin.html" class="small text-decoration-none">Giáo viên</a></div>
    </div>
    <div class="exam-type-tabs mb-2">
        <div class="type-tab active" onclick="setType('tx', this)">Thường xuyên</div>
        <div class="type-tab" onclick="setType('gk1', this)">Giữa kỳ 1</div>
        <div class="type-tab" onclick="setType('ck1', this)">Cuối kỳ 1</div>
        <div class="type-tab" onclick="setType('gk2', this)">Giữa kỳ 2</div>
        <div class="type-tab" onclick="setType('ck2', this)">Cuối kỳ 2</div>
    </div>
    <div id="chapter-filters" class="mb-3 d-flex flex-wrap"></div>
    <div id="exam-grid"></div>
</div>

<div id="exam-screen">
    <div class="exam-header-bar">
        <button onclick="toggleOverview()" class="btn btn-sm btn-outline-primary fw-bold"><i class="bi bi-list-task"></i> Danh sách</button>
        <div class="timer-box" id="exam-timer">00:00</div>
        <button onclick="submitExam()" class="btn btn-sm btn-success fw-bold px-3 shadow submit-btn">NỘP</button>
    </div>
    <div id="overview-screen">
        <h5 class="fw-bold text-center text-primary mb-3 text-uppercase">TỔNG HỢP BÀI LÀM</h5>
        <div id="overview-content"></div> 
        <button onclick="toggleOverview()" class="btn btn-secondary w-100 py-3 fw-bold rounded-pill mt-auto shadow">QUAY LẠI LÀM TIẾP</button>
    </div>
    <div class="pdf-container"><iframe id="pdf-frame"></iframe></div>
    <div class="qa-container" id="qa-container">
        <div id="result-box" class="d-none text-center pt-4">
            <h1 class="display-3 fw-bold text-success mb-0" id="score-display">--</h1>
            <small class="text-uppercase fw-bold text-muted">Điểm số</small>
            <div id="sol-link-area" class="mt-3"></div>
            <button onclick="location.reload()" class="btn btn-outline-secondary w-100 mt-4 rounded-pill">Về trang chủ</button>
        </div>
        <div id="question-content"></div>
        <div id="essay-area" class="card p-3 mt-3 border-warning bg-light d-none">
            <label class="small fw-bold mb-2"><i class="bi bi-camera-fill"></i> Tự luận:</label>
            <input type="file" id="essay-files" class="form-control" multiple accept="image/*">
        </div>
    </div>
    <div class="nav-bottom" id="nav-bar-fixed">
        <button class="nav-circle" onclick="prevQ()"><i class="bi bi-chevron-left"></i></button>
        <div class="d-flex align-items-center gap-2"><span>Câu</span><input type="number" id="jump-input" value="1" min="1" class="form-control text-center fw-bold p-0 border-0" style="width:40px;font-size:1.1rem" onchange="jumpQ()"><span class="small text-muted" id="total-q">/ --</span></div>
        <button class="nav-circle" onclick="nextQ()"><i class="bi bi-chevron-right"></i></button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyUE1yDW2-NO_B8snzw0Z0PPYa4GCZBox09kJeLLWxEYRpqp8EazFZBWyQ1h6b3uHFHKg/exec"; 
    
    let allExams=[], currentFilter={class:'6',type:'tx',chapter:'1'};
    let currentExam=null, userAnswers={}, questionMap=[], qIdx=0, studentInfo={id:'', name:''}, timerInterval;
    let historyData = null;

    window.onload = async () => { setTimeout(() => document.getElementById('loading').style.display='none', 8000); updateClassAndFilter(); renderChapters(); await fetchExams(); };
    
    // --- FIX LOGIC CHỌN LỚP ---
    function updateClassAndFilter() { 
        const grade = document.getElementById('sel-grade').value; 
        const clsSel = document.getElementById('sel-class'); 
        
        // Reset dropdown
        clsSel.innerHTML = '<option value="">- Chọn Lớp -</option>'; 
        
        // Populate
        let letters = (grade <= 9) ? ['A','B','C','D','E'] : ['A','B','C']; 
        letters.forEach(L => clsSel.innerHTML += `<option value="${grade}${L}">${grade}${L}</option>`); 
        
        currentFilter.class = grade; 
        filterExams(); 
    }

    async function loadStudents() { 
        const cls = document.getElementById('sel-class').value; 
        const stuSel = document.getElementById('sel-student'); 
        
        if(!cls) { stuSel.disabled=true; return; } 
        stuSel.innerHTML = '<option>Đang tải...</option>'; 
        
        try { 
            const res = await fetch(API_URL + `?action=getStudentsByClass&className=${cls}`); 
            const json = await res.json(); 
            stuSel.innerHTML = '<option value="">-- Chọn tên --</option>'; 
            if(json.data && json.data.length > 0) { 
                json.data.forEach(s => stuSel.innerHTML += `<option value="${s.id}|${s.name}">${s.name}</option>`); 
                stuSel.disabled = false; 
            } else {
                stuSel.innerHTML = '<option value="">Chưa có danh sách</option>';
            }
        } catch(e) { stuSel.innerHTML='<option>Lỗi tải</option>'; } 
    }

    async function fetchExams() { try { const res = await fetch(API_URL + "?action=getExams&t=" + Date.now()); const json = await res.json(); allExams = json.data || []; filterExams(); } catch(e) {} document.getElementById('loading').style.display='none'; }
    function filterExams() { const grid = document.getElementById('exam-grid'); const list = allExams.filter(e => e.classGrade == currentFilter.class && e.examType == currentFilter.type && (currentFilter.type!=='tx' || e.chapter == currentFilter.chapter)); if(list.length===0) { grid.innerHTML='<div class="text-center text-muted py-5 small">Chưa có đề thi.</div>'; return; } grid.innerHTML = list.map(e => `<div class="exam-card" onclick='preStart(${JSON.stringify(e).replace(/'/g,"&#39;")})'><div class="d-flex justify-content-between align-items-center"><div><div class="fw-bold text-dark text-truncate" style="max-width: 250px;">${e.title}</div><div class="small text-muted mt-1"><i class="bi bi-clock"></i> ${e.duration}' &bull; ${e.totalQuestions} câu</div></div><button class="btn btn-sm btn-outline-primary rounded-pill fw-bold">Thi</button></div></div>`).join(''); }
    function setType(t, btn) { currentFilter.type=t; document.querySelectorAll('.type-tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); document.getElementById('chapter-filters').style.display=t==='tx'?'flex':'none'; filterExams(); }
    function renderChapters() { let h=''; for(let i=1;i<=8;i++) h+=`<span class="grade-pill ${i==1?'active':''}" onclick="currentFilter.chapter='${i}';document.querySelectorAll('.grade-pill').forEach(c=>c.classList.remove('active'));this.classList.add('active');filterExams()">Chương ${i}</span>`; document.getElementById('chapter-filters').innerHTML=h; }
    
    // --- CHECK HISTORY ---
    async function preStart(exam) {
        const val = document.getElementById('sel-student').value;
        if(!val || val.includes("Chọn") || val === "") return alert("Vui lòng chọn Tên Học Sinh!");
        const [id, name] = val.split('|'); studentInfo = {id, name}; currentExam = exam;
        
        document.getElementById('loading').style.display='flex';
        try {
            const res = await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'checkStudentHistory', maHS:id, maDe:exam.id})});
            const json = await res.json();
            document.getElementById('loading').style.display='none';
            if(json.success && json.count > 0) {
                historyData=json; document.getElementById('his-count').innerText=json.count; document.getElementById('his-score').innerText=json.lastScore;
                new bootstrap.Modal(document.getElementById('historyModal')).show();
            } else { startExam(true); }
        } catch(e) { startExam(true); }
    }

    function reviewOldExam() {
        bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide();
        try { userAnswers = JSON.parse(historyData.lastAnswers); } catch(e) { userAnswers={}; }
        startExam(false);
        document.querySelector('.submit-btn').style.display='none';
        document.getElementById('result-box').classList.remove('d-none');
        document.getElementById('score-display').innerText = historyData.lastScore;
        if(currentExam.solutionLink) document.getElementById('sol-link-area').innerHTML = `<a href="${currentExam.solutionLink.replace('/view','/preview')}" target="_blank" class="btn btn-primary w-100 py-2 fw-bold">XEM LỜI GIẢI</a>`;
    }

    function startExam(isNew) {
        if(document.getElementById('historyModal').classList.contains('show')) bootstrap.Modal.getInstance(document.getElementById('historyModal')).hide();
        if(isNew) { userAnswers={}; document.getElementById('result-box').classList.add('d-none'); document.querySelector('.submit-btn').style.display='block'; }
        
        qIdx=0; questionMap=[];
        let st=(typeof currentExam.structure==='string')?JSON.parse(currentExam.structure):currentExam.structure;
        let c=st.config||{}; let gId=1;
        for(let i=1; i<=c.mcq; i++) questionMap.push({type:'mcq', id:i, displayId:gId++, lbl:`Câu ${gId-1}`});
        for(let i=1; i<=c.tf; i++) questionMap.push({type:'tf', id:i, displayId:gId++, lbl:`Câu ${gId-1}`});
        for(let i=1; i<=c.short; i++) questionMap.push({type:'sh', id:i, displayId:gId++, lbl:`Câu ${gId-1}`});

        document.getElementById('home-screen').classList.add('d-none'); document.querySelector('header').classList.add('d-none'); document.getElementById('exam-screen').style.display = 'flex';
        document.getElementById('pdf-frame').src = currentExam.pdfLink.replace('/view','/preview');
        document.getElementById('total-q').innerText = "/ " + questionMap.length; document.getElementById('jump-input').max = questionMap.length;
        if(currentExam.isEssay) document.getElementById('essay-area').classList.remove('d-none');
        if(isNew) startTimer(currentExam.duration);
        renderQ(0);
    }

    function startTimer(m) { let t = m * 60; const d = document.getElementById('exam-timer'); clearInterval(timerInterval); timerInterval = setInterval(() => { let mn = Math.floor(t / 60), sc = t % 60; d.innerText = `${mn}:${sc<10?'0':''}${sc}`; if (t <= 0) { clearInterval(timerInterval); alert("Hết giờ!"); submitExam(true); } t--; }, 1000); }
    function toggleOverview() { const s=document.getElementById('overview-screen'); if(s.style.display==='flex')s.style.display='none'; else {renderOverview();s.style.display='flex';} }
    function renderOverview() {
        const c=document.getElementById('overview-content'); c.innerHTML='';
        const rnd=(tit,qs,cls)=>{ if(qs.length===0)return''; let h=`<div class="part-header">${tit}</div><div class="${cls}">`; qs.forEach(q=>{ let a='',done=false; if(q.type=='mcq') a=userAnswers[`p1_c${q.id}`]||''; if(q.type=='sh') a=userAnswers[`p3_c${q.id}`]||''; if(a) done=true; if(q.type=='sh'&&a.length>4)a='...'; let ridx=questionMap.findIndex(x=>x.displayId==q.displayId); h+=`<div class="q-cell ${done?'q-done':''}" onclick="jumpTo(${ridx})"><span style="font-size:0.8rem">${q.displayId}</span><span class="q-cell-ans">${a}</span></div>`; }); return h+'</div>'; };
        const rndTF=(tit,qs)=>{ if(qs.length===0)return''; let h=`<div class="part-header">${tit}</div><div class="grid-tf">`; qs.forEach(q=>{ let ridx=questionMap.findIndex(x=>x.displayId==q.displayId), b=''; ['a','b','c','d'].forEach(s=>{ let u=userAnswers[`p2_c${q.id}_${s}`], t=u=='D'?'Đ':(u=='S'?'S':'-'), css=u=='D'?'done':(u=='S'?'false':''); b+=`<span class="tf-badge ${css}">${s})${t}</span>`; }); h+=`<div class="tf-summary-row" onclick="jumpTo(${ridx})"><span class="tf-summary-id">Câu ${q.displayId}</span><div class="tf-badges">${b}</div></div>`; }); return h+'</div>'; };
        c.innerHTML+=rnd("PHẦN I. TRẮC NGHIỆM KHÁCH QUAN",questionMap.filter(q=>q.type=='mcq'),'grid-mcq');
        c.innerHTML+=rndTF("PHẦN II. TRẮC NGHIỆM ĐÚNG SAI",questionMap.filter(q=>q.type=='tf'));
        c.innerHTML+=rnd("PHẦN III. TRẢ LỜI NGẮN",questionMap.filter(q=>q.type=='sh'),'grid-short');
    }
    function jumpTo(i) { renderQ(i); document.getElementById('overview-screen').style.display='none'; }
    function renderQ(i) {
        if(i<0||i>=questionMap.length)return; qIdx=i; document.getElementById('jump-input').value=i+1; const q=questionMap[i], box=document.getElementById('question-content');
        let t=q.type=='mcq'?'TRẮC NGHIỆM':(q.type=='tf'?'ĐÚNG SAI':'TRẢ LỜI NGẮN'); let h=`<div class="mb-3"><span class="badge bg-secondary mb-2">${t}</span><h5 class="fw-bold text-primary">${q.lbl}</h5></div>`;
        if(q.type=='mcq') { h+=`<div class="mcq-row">`; ['A','B','C','D'].forEach(o=>{ let act=userAnswers[`p1_c${q.id}`]==o?'active-opt':''; h+=`<div class="opt-btn ${act}" onclick="ans('p1_c${q.id}','${o}')"><div class="opt-char">${o}</div></div>`; }); h+='</div>'; }
        else if(q.type=='tf') { h+=`<div class="tf-grid">`; ['a','b','c','d'].forEach(s=>{ let u=userAnswers[`p2_c${q.id}_${s}`]; h+=`<div class="tf-item"><div class="fw-bold small mb-1">Ý (${s})</div><div class="d-flex gap-1"><button class="tf-btn ${u=='D'?'tf-active-d':''}" onclick="ans('p2_c${q.id}_${s}','D')">Đ</button><button class="tf-btn ${u=='S'?'tf-active-s':''}" onclick="ans('p2_c${q.id}_${s}','S')">S</button></div></div>`; }); h+='</div>'; }
        else { let v=userAnswers[`p3_c${q.id}`]||''; h+=`<input type="text" class="form-control form-control-lg text-center fw-bold mt-2" placeholder="Nhập đáp án..." value="${v}" oninput="userAnswers['p3_c${q.id}']=this.value.trim()">`; }
        box.innerHTML=h;
    }
    function ans(k,v) { userAnswers[k]=v; renderQ(qIdx); }
    function prevQ() { renderQ(qIdx-1); } function nextQ() { renderQ(qIdx+1); } function jumpQ() { renderQ(parseInt(document.getElementById('jump-input').value)-1); }
    async function submitExam(auto=false) {
        if(!auto&&!confirm("Nộp bài?"))return; clearInterval(timerInterval); document.getElementById('loading').style.display='flex';
        let st=(typeof currentExam.structure==='string')?JSON.parse(currentExam.structure):currentExam.structure, k=st.answers||{}, cf=st.config||{}, s1=0, s2=0, s3=0;
        let c1=0; for(let i=1; i<=cf.mcq; i++) if(userAnswers[`p1_c${i}`]===k[`p1_c${i}`]) c1++; if(cf.mcq>0) s1=(3.0/cf.mcq)*c1;
        let c3=0; for(let i=1; i<=cf.short; i++) { let u=(userAnswers[`p3_c${i}`]||"").toUpperCase().trim(), ky=(k[`p3_c${i}`]||"").toUpperCase().trim(); if(u===ky&&ky!=="") c3++; } if(cf.short>0) s3=(3.0/cf.short)*c3;
        for(let i=1; i<=cf.tf; i++) { let c=0; ['a','b','c','d'].forEach(s=>{ if(userAnswers[`p2_c${i}_${s}`]===k[`p2_c${i}_${s}`]) c++; }); if(c==1)s2+=0.1;else if(c==2)s2+=0.25;else if(c==3)s2+=0.5;else if(c==4)s2+=1.0; }
        let total=(s1+s2+s3).toFixed(2); if(total>10) total=10;
        let imgs=[]; const files=document.getElementById('essay-files').files; if(files.length){ const toB64=f=>new Promise(r=>{const fr=new FileReader();fr.readAsDataURL(f);fr.onload=()=>r(fr.result)}); for(let f of files) imgs.push(await toB64(f)); }
        try { await fetch(API_URL, {method:'POST', body:JSON.stringify({ action:'submitExam', maHS:studentInfo.id, tenHS:studentInfo.name, maDe:currentExam.id, score:total, studentAnswers:userAnswers, detailResult:{}, images:imgs })}); } catch(e) {}
        document.getElementById('question-content').innerHTML=''; document.getElementById('nav-bar-fixed').style.display='none'; document.querySelector('.exam-header-bar').style.display='none'; document.getElementById('result-box').classList.remove('d-none'); document.getElementById('score-display').innerText=total;
        if(currentExam.solutionLink) document.getElementById('sol-link-area').innerHTML=`<a href="${currentExam.solutionLink.replace('/view','/preview')}" target="_blank" class="btn btn-primary w-100 py-2 fw-bold">XEM LỜI GIẢI</a>`;
        document.getElementById('loading').style.display='none';
    }
</script>
</body>
</html>