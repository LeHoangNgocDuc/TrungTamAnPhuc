<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Nh·∫≠p ƒê·ªÅ Thi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>if (!sessionStorage.getItem("isAdmin")) window.location.href = "login.html";</script>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between">
                <h5 class="mb-0 fw-bold">QU·∫¢N L√ù ƒê·ªÄ THI</h5>
                <a href="index.html" class="btn btn-sm btn-light fw-bold" target="_blank">Xem trang HS</a>
            </div>
            <div class="card-body">
                
                <h6 class="text-primary fw-bold border-bottom pb-2">1. Ph√¢n lo·∫°i ƒê·ªÅ thi</h6>
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">L·ªõp h·ªçc</label>
                        <select id="exam-class" class="form-select">
                            <option value="6">To√°n 6</option>
                            <option value="7">To√°n 7</option>
                            <option value="8">To√°n 8</option>
                            <option value="9">To√°n 9</option>
                            <option value="10">To√°n 10</option>
                            <option value="11">To√°n 11</option>
                            <option value="12">To√°n 12</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Lo·∫°i k·ª≥ thi</label>
                        <select id="exam-type" class="form-select" onchange="toggleChapter()">
                            <option value="tx">Ki·ªÉm tra th∆∞·ªùng xuy√™n</option>
                            <option value="gk1">Gi·ªØa k·ª≥ 1</option>
                            <option value="ck1">Cu·ªëi k·ª≥ 1</option>
                            <option value="gk2">Gi·ªØa k·ª≥ 2</option>
                            <option value="ck2">Cu·ªëi k·ª≥ 2</option>
                            <option value="thpt">Th·ª≠ THPT QG</option>
                        </select>
                    </div>
                    <div class="col-md-4" id="div-chapter">
                        <label class="form-label fw-bold">Ch∆∞∆°ng (1-8)</label>
                        <select id="exam-chapter" class="form-select">
                            <option value="1">Ch∆∞∆°ng 1</option>
                            <option value="2">Ch∆∞∆°ng 2</option>
                            <option value="3">Ch∆∞∆°ng 3</option>
                            <option value="4">Ch∆∞∆°ng 4</option>
                            <option value="5">Ch∆∞∆°ng 5</option>
                            <option value="6">Ch∆∞∆°ng 6</option>
                            <option value="7">Ch∆∞∆°ng 7</option>
                            <option value="8">Ch∆∞∆°ng 8</option>
                        </select>
                    </div>
                </div>

                <h6 class="text-primary fw-bold border-bottom pb-2 mt-4">2. Th√¥ng tin & Link Drive</h6>
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <input type="text" id="exam-id" class="form-control" placeholder="M√£ ƒê·ªÅ (VD: TOAN6-C1-01)">
                    </div>
                    <div class="col-md-9">
                        <input type="text" id="exam-title" class="form-control" placeholder="T√™n ƒê·ªÅ Thi (VD: √în t·∫≠p ch∆∞∆°ng 1...)">
                    </div>
                    <div class="col-md-6">
                        <input type="text" id="link-exam" class="form-control" placeholder="Link Drive ƒê·ªÅ (PDF) *">
                    </div>
                    <div class="col-md-6">
                        <input type="text" id="link-sol" class="form-control" placeholder="Link Drive ƒê√°p √°n (PDF)">
                    </div>
                    <div class="col-md-4">
                        <input type="number" id="exam-duration" class="form-control" value="45" placeholder="Ph√∫t">
                    </div>
                    <div class="col-md-8 pt-2">
                         <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is-essay">
                            <label class="form-check-label fw-bold" for="is-essay">C√≥ T·ª± lu·∫≠n (N·ªôp ·∫£nh)</label>
                        </div>
                    </div>
                </div>

                <h6 class="text-primary fw-bold border-bottom pb-2 mt-4">3. Nh·∫≠p ƒê√°p √Ån (T·ª± ƒë·ªông t·ª´ Word)</h6>
                <div class="mb-3">
                    <input type="file" id="word-upload" accept=".docx" class="d-none" onchange="handleWordUpload(this)">
                    <button onclick="document.getElementById('word-upload').click()" class="btn btn-warning btn-sm fw-bold">üìÇ Ch·ªçn file ƒê√°p √Ån (.docx)</button>
                </div>

                <div class="row g-2 bg-white p-3 border rounded mb-3">
                    <div class="col-md-4"><label>S·ªë c√¢u TN</label><input type="number" id="num-mcq" class="form-control" value="0"></div>
                    <div class="col-md-4"><label>S·ªë c√¢u ƒê/S</label><input type="number" id="num-tf" class="form-control" value="0"></div>
                    <div class="col-md-4"><label>S·ªë c√¢u Ng·∫Øn</label><input type="number" id="num-short" class="form-control" value="0"></div>
                    <div class="col-12 text-end"><button onclick="generateForm()" class="btn btn-secondary btn-sm mt-2">V·∫Ω Form</button></div>
                </div>

                <div id="answer-area" class="d-none bg-light p-3 border rounded mb-3"></div>

                <button onclick="saveExamFinal()" id="btn-save" class="btn btn-success w-100 py-3 fw-bold fs-5">L∆ØU ƒê·ªÄ THI</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzZWaaHxROI9_r4LluKvL-cWdLsTmaZ90Euw27tO53AGUkRQ5N-YLegV7u_5zAr5QTYHg/exec"; // THAY LINK C·ª¶A B·∫†N
        let answerData = {};

        function toggleChapter() {
            const type = document.getElementById('exam-type').value;
            // Ch·ªâ hi·ªán ch∆∞∆°ng khi ch·ªçn Ki·ªÉm tra th∆∞·ªùng xuy√™n
            document.getElementById('div-chapter').style.display = (type === 'tx') ? 'block' : 'none';
        }

        // --- CODE X·ª¨ L√ù WORD V√Ä FORM (GI·ªÆ NGUY√äN NH∆Ø C≈® - ƒê√É T·ªêT) ---
        // (B·∫°n copy l·∫°i ƒëo·∫°n x·ª≠ l√Ω handleWordUpload, parseDocContent, generateForm t·ª´ phi√™n b·∫£n tr∆∞·ªõc d√°n v√†o ƒë√¢y)
        // T√¥i vi·∫øt t·∫Øt ph·∫ßn n√†y ƒë·ªÉ t·∫≠p trung v√†o logic m·ªõi
        function handleWordUpload(input) { /* ... Code x·ª≠ l√Ω Word c≈© ... */ }
        function parseDocContent(html) { /* ... Code x·ª≠ l√Ω Word c≈© ... */ }
        function generateForm() { /* ... Code x·ª≠ l√Ω Form c≈© ... */ }
        function saveKey(k,v) { answerData[k] = v.trim().toUpperCase(); }

        // --- H√ÄM L∆ØU M·ªöI (TH√äM PH√ÇN LO·∫†I) ---
        async function saveExamFinal() {
            const btn = document.getElementById('btn-save');
            const id = document.getElementById('exam-id').value;
            const linkExam = document.getElementById('link-exam').value;
            
            if(!id || !linkExam) return alert("Thi·∫øu M√£ ƒë·ªÅ ho·∫∑c Link ƒê·ªÅ!");

            btn.innerHTML = "ƒêANG L∆ØU..."; btn.disabled = true;

            const payload = {
                action: "addExam",
                id: id, title: document.getElementById('exam-title').value,
                duration: document.getElementById('exam-duration').value,
                isEssay: document.getElementById('is-essay').checked,
                pdfLink: linkExam,
                solLink: document.getElementById('link-sol').value,
                
                // D·ªØ li·ªáu ph√¢n lo·∫°i m·ªõi
                classGrade: document.getElementById('exam-class').value,
                examType: document.getElementById('exam-type').value,
                chapter: document.getElementById('exam-type').value === 'tx' ? document.getElementById('exam-chapter').value : "",

                totalQuestions: (parseInt(document.getElementById('num-mcq').value)||0)+(parseInt(document.getElementById('num-tf').value)||0)+(parseInt(document.getElementById('num-short').value)||0),
                structure: {
                    config: {
                        mcq: parseInt(document.getElementById('num-mcq').value)||0,
                        tf: parseInt(document.getElementById('num-tf').value)||0,
                        short: parseInt(document.getElementById('num-short').value)||0
                    },
                    answers: answerData
                }
            };

            try {
                await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'text/plain'}, body: JSON.stringify(payload) });
                alert("‚úÖ ƒê√£ l∆∞u ƒë·ªÅ thi!"); location.reload();
            } catch(e) { alert("L·ªói: "+e); btn.innerHTML = "L∆ØU L·∫†I"; btn.disabled = false; }
        }
    </script>
</body>
</html>