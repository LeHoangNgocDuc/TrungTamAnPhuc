<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Quản Trị</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>body{background:#f0f2f5;padding-bottom:50px}.nav-pills .nav-link.active{background:#0d6efd}</style>
    <script>if(!sessionStorage.getItem("isAdmin")) window.location.href="login.html";</script>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4 shadow">
        <div class="container">
            <span class="navbar-brand fw-bold">QUẢN TRỊ VIÊN</span>
            <a href="index.html" class="btn btn-light btn-sm fw-bold">Về trang thi</a>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm justify-content-center" id="pills-tab">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-student">1. Quản Lý HS</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-exam">2. Nhập Đề Thi</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-rank">3. Xem Điểm</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="pills-student">
                <div class="card p-3 border-success shadow-sm">
                    <h6 class="fw-bold text-success">UPLOAD DANH SÁCH HS (Excel)</h6>
                    <input type="file" id="file-student" class="form-control mb-2">
                    <button onclick="importStudents()" class="btn btn-success">Tải lên</button>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-exam">
                <div class="card p-3 shadow-sm">
                    <h6 class="fw-bold text-primary mb-3">NHẬP ĐỀ MỚI & ĐÁP ÁN (TỪ WORD)</h6>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-md-3 col-6">
                            <label class="small fw-bold">Khối</label>
                            <select id="exam-class" class="form-select fw-bold text-primary">
                                <option value="6">6</option><option value="7">7</option><option value="8">8</option>
                                <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                            </select>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="small fw-bold">Loại</label>
                            <select id="exam-type" class="form-select fw-bold text-danger" onchange="toggleChapter()">
                                <option value="tx">Thường xuyên</option>
                                <option value="gk1">Giữa Kỳ 1</option><option value="ck1">Cuối Kỳ 1</option>
                                <option value="gk2">Giữa Kỳ 2</option><option value="ck2">Cuối Kỳ 2</option>
                            </select>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="small fw-bold">Chương</label>
                            <select id="exam-chapter" class="form-select"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select>
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="small fw-bold">Phút</label>
                            <input type="number" id="exam-duration" class="form-control" value="90">
                        </div>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-3"><input type="text" id="exam-id" class="form-control" placeholder="Mã Đề"></div>
                        <div class="col-9"><input type="text" id="exam-title" class="form-control" placeholder="Tên Đề"></div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><input type="text" id="link-exam" class="form-control" placeholder="Link PDF Đề"></div>
                        <div class="col-6"><input type="text" id="link-sol" class="form-control" placeholder="Link PDF Giải"></div>
                    </div>

                    <div class="border p-2 bg-light rounded mb-3">
                        <label class="fw-bold text-success mb-2"><i class="bi bi-file-word"></i> Chọn File Word chứa Bảng Đáp Án:</label>
                        <input type="file" id="word-upload" onchange="handleWordUpload(this)" class="form-control">
                        <small class="text-muted fst-italic">Hỗ trợ đọc bảng đáp án Phần 1 (TN), Phần 2 (Đ/S), Phần 3 (Điền khuyết)</small>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-4"><input id="num-mcq" class="form-control" placeholder="Số câu TN"></div>
                        <div class="col-4"><input id="num-tf" class="form-control" placeholder="Số câu Đ/S"></div>
                        <div class="col-4"><input id="num-short" class="form-control" placeholder="Số câu Ngắn"></div>
                    </div>
                    
                    <button onclick="saveExamFinal()" id="btn-save" class="btn btn-primary w-100 fw-bold mt-2">LƯU ĐỀ THI</button>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-rank">
                <div class="card p-3 border-warning shadow-sm">
                    <h6 class="fw-bold">KẾT QUẢ THI</h6>
                    <div class="row g-2 mb-3">
                        <div class="col-3"><select id="stat-grade" class="form-select" onchange="updateStatExamList()"><option value="6">6</option><option value="12">12</option></select></div>
                        <div class="col-3"><select id="stat-type" class="form-select" onchange="updateStatExamList()"><option value="tx">TX</option><option value="gk1">GK1</option></select></div>
                        <div class="col-4"><select id="stat-exam" class="form-select"><option value="">--</option></select></div>
                        <div class="col-2"><button onclick="viewRankings()" class="btn btn-warning w-100">Xem</button></div>
                    </div>
                    <table class="table table-bordered table-sm small"><thead class="table-dark"><tr><th>#</th><th>Tên</th><th>Điểm</th><th>TG</th></tr></thead><tbody id="rank-table-body"></tbody></table>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ===============================================================
    // DÁN LINK WEB APP CỦA BẠN VÀO ĐÂY
    const API_URL = "https://script.google.com/macros/s/AKfycby7FKjCdaorqBhmTAJcvvuAzgA-Oughz46uciokQ8AGugTl9DnAvkkhy2e8K1ELm4BjBg/exec"; 
    // ===============================================================

    let allExams = [];
    window.tempAnswers = {}; // Lưu tạm đáp án sau khi parse Word

    window.onload = async () => {
        try {
            const res = await fetch(API_URL + "?action=getExams&role=admin&t="+Date.now());
            const json = await res.json(); allExams = json.data||[]; updateStatExamList();
        } catch(e){}
    };

    function toggleChapter() { document.getElementById('exam-chapter').disabled = (document.getElementById('exam-type').value !== 'tx'); }
    function importStudents() { /* Logic import Excel cũ */ }
    
    // --- UPDATE: XỬ LÝ FILE WORD ---
    function handleWordUpload(inp){
        const f=inp.files[0]; if(!f) return;
        const r=new FileReader();
        r.onload=e=>mammoth.convertToHtml({arrayBuffer:e.target.result}).then(r=>parseAnsDoc(r.value));
        r.readAsArrayBuffer(f);
    }

    function parseAnsDoc(html){
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        let config = { mcq: 0, tf: 0, short: 0 };
        let answers = {};
        
        // Tìm các bảng trong file Word
        const tables = doc.querySelectorAll('table');
        tables.forEach(tbl => {
            const txt = tbl.innerText;
            const rows = tbl.querySelectorAll('tr');

            // 1. NHẬN DIỆN PHẦN 1 (MCQ): Có dạng "1.A" hoặc "1. A"
            if(txt.match(/\d+[\.:\s]+[A-D]/)) {
                 tbl.querySelectorAll('td').forEach(td => {
                    // Regex tìm: Số câu + Dấu chấm/hai chấm + Khoảng trắng + Chữ cái A-D
                    const matches = td.innerText.matchAll(/(\d+)\s*[\.:]\s*([A-D])/gi);
                    for (const m of matches) {
                        const q = parseInt(m[1]);
                        answers[`p1_c${q}`] = m[2].toUpperCase();
                        if(q > config.mcq) config.mcq = q;
                    }
                 });
            }

            // 2. NHẬN DIỆN PHẦN 2 (ĐÚNG SAI): Có "Câu 1", "a) Đúng/Sai"
            else if(txt.includes("a)") && (txt.includes("Đúng") || txt.includes("Sai"))) {
                // Header (Câu 1, Câu 2...) để biết cột nào là câu nào
                let colMap = [];
                if(rows.length > 0) {
                    rows[0].querySelectorAll('td').forEach((td, idx) => {
                        const m = td.innerText.match(/Câu\s*(\d+)/i);
                        if(m) colMap[idx] = parseInt(m[1]);
                    });
                }
                // Duyệt các dòng chứa ý a, b, c, d
                for(let i=1; i<rows.length; i++) {
                    rows[i].querySelectorAll('td').forEach((td, cIdx) => {
                        const qNum = colMap[cIdx];
                        if(qNum) {
                            const raw = td.innerText.trim();
                            const subM = raw.match(/^([a-d])\)/i);     // Tìm a) b)
                            const valM = raw.match(/(Đúng|Sai)/i);     // Tìm Đúng/Sai
                            if(subM && valM) {
                                const sub = subM[1].toLowerCase();
                                const val = valM[1].toLowerCase() === "đúng" ? "D" : "S";
                                answers[`p2_c${qNum}_${sub}`] = val;
                                if(qNum > config.tf) config.tf = qNum;
                            }
                        }
                    });
                }
            }

            // 3. NHẬN DIỆN PHẦN 3 (TRẢ LỜI NGẮN): Hàng chứa số, hàng chứa đáp án
            else {
                // Thường bảng ngắn có hàng 1 là số câu (1, 2, 3..), hàng 2 là đáp án
                if(rows.length >= 2) {
                    const r0 = rows[0].querySelectorAll('td');
                    const r1 = rows[1].querySelectorAll('td');
                    // Check nếu r0 toàn số
                    let isPart3 = false;
                    r0.forEach((td, idx) => {
                         const num = parseInt(td.innerText.trim());
                         if(!isNaN(num) && r1[idx]) {
                             // Lấy đáp án ở dòng dưới
                             let ansVal = r1[idx].innerText.replace("Chọn","").trim(); // Xóa chữ "Chọn" nếu có
                             if(ansVal) {
                                 answers[`p3_c${num}`] = ansVal;
                                 if(num > config.short) config.short = num;
                                 isPart3 = true;
                             }
                         }
                    });
                }
            }
        });

        // Điền số liệu vào form
        document.getElementById('num-mcq').value = config.mcq;
        document.getElementById('num-tf').value = config.tf;
        document.getElementById('num-short').value = config.short;
        window.tempAnswers = answers; // Lưu biến tạm
        alert(`Đã đọc xong!\n- Trắc nghiệm: ${config.mcq}\n- Đúng/Sai: ${config.tf}\n- Ngắn: ${config.short}`);
    }

    async function saveExamFinal() {
        const btn = document.getElementById('btn-save'); btn.innerText="Đang lưu..."; btn.disabled=true;
        const cfg = {
            mcq: parseInt(document.getElementById('num-mcq').value)||0,
            tf: parseInt(document.getElementById('num-tf').value)||0,
            short: parseInt(document.getElementById('num-short').value)||0
        };
        const py={
            action:"addExam", 
            id:document.getElementById('exam-id').value, title:document.getElementById('exam-title').value,
            pdfLink:document.getElementById('link-exam').value, solLink:document.getElementById('link-sol').value,
            duration:document.getElementById('exam-duration').value, isEssay:false,
            classGrade:document.getElementById('exam-class').value, examType:document.getElementById('exam-type').value,
            chapter:document.getElementById('exam-chapter').value,
            totalQuestions: cfg.mcq + cfg.tf + cfg.short,
            structure: { config: cfg, answers: window.tempAnswers || {} }
        };
        fetch(API_URL,{method:'POST',body:JSON.stringify(py)}).then(r=>r.json()).then(j=>{ alert("Lưu thành công!"); location.reload(); });
    }
    
    // Logic bảng xếp hạng (như cũ)
    function updateStatExamList(){ /* ... */ }
    function viewRankings(){ /* ... */ }
</script>
</body>
</html>