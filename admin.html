<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Nh·∫≠p ƒê·ªÅ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">NH·∫¨P ƒê·ªÄ THI M·ªöI</h5>
            </div>
            <div class="card-body">
                <h6 class="text-primary fw-bold border-bottom pb-2">1. Ph√¢n lo·∫°i</h6>
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="fw-bold">L·ªõp</label>
                        <select id="exam-class" class="form-select">
                            <option value="6">L·ªõp 6</option><option value="7">L·ªõp 7</option>
                            <option value="8">L·ªõp 8</option><option value="9">L·ªõp 9</option>
                            <option value="10">L·ªõp 10</option><option value="11">L·ªõp 11</option>
                            <option value="12">L·ªõp 12</option><option value="TN">TN THPT</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="fw-bold">Lo·∫°i K·ª≥ Thi</label>
                        <select id="exam-type" class="form-select" onchange="toggleChapter()">
                            <option value="tx">Ki·ªÉm tra th∆∞·ªùng xuy√™n</option>
                            <option value="gk1">Gi·ªØa k·ª≥ 1</option>
                            <option value="ck1">Cu·ªëi k·ª≥ 1</option>
                            <option value="gk2">Gi·ªØa k·ª≥ 2</option>
                            <option value="ck2">Cu·ªëi k·ª≥ 2</option>
                            <option value="thpt">Th·ª≠ THPT QG</option>
                        </select>
                    </div>
                    <div class="col-md-4" id="div-chapter">
                        <label class="fw-bold">Ch∆∞∆°ng</label>
                        <select id="exam-chapter" class="form-select">
                            <option value="1">Ch∆∞∆°ng 1</option><option value="2">Ch∆∞∆°ng 2</option>
                            <option value="3">Ch∆∞∆°ng 3</option><option value="4">Ch∆∞∆°ng 4</option>
                            <option value="5">Ch∆∞∆°ng 5</option><option value="6">Ch∆∞∆°ng 6</option>
                            <option value="7">Ch∆∞∆°ng 7</option><option value="8">Ch∆∞∆°ng 8</option>
                        </select>
                    </div>
                </div>

                <h6 class="text-primary fw-bold border-bottom pb-2 mt-4">2. Th√¥ng tin & Link Drive</h6>
                <div class="row g-3 mb-3">
                    <div class="col-md-3"><input type="text" id="exam-id" class="form-control" placeholder="M√£ ƒê·ªÅ (VD: TOAN6-01)"></div>
                    <div class="col-md-9"><input type="text" id="exam-title" class="form-control" placeholder="T√™n ƒê·ªÅ Thi"></div>
                    
                    <div class="col-md-6">
                        <label class="text-danger fw-bold">Link ƒê·ªÅ (PDF) *</label>
                        <input type="text" id="link-exam" class="form-control" placeholder="D√°n link Google Drive v√†o ƒë√¢y">
                    </div>
                    <div class="col-md-6">
                        <label class="text-success fw-bold">Link ƒê√°p √Ån (PDF) (ƒê·ªÉ HS xem sau khi thi)</label>
                        <input type="text" id="link-sol" class="form-control" placeholder="D√°n link Google Drive v√†o ƒë√¢y">
                    </div>
                    
                    <div class="col-md-4">
                        <input type="number" id="exam-duration" class="form-control" value="45" placeholder="Ph√∫t">
                    </div>
                    <div class="col-md-8 pt-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is-essay">
                            <label class="form-check-label fw-bold">C√≥ ph·∫ßn T·ª± lu·∫≠n (N·ªôp ·∫£nh)</label>
                        </div>
                    </div>
                </div>

                <h6 class="text-primary fw-bold border-bottom pb-2 mt-4">3. Nh·∫≠p Ma tr·∫≠n ƒê√°p √°n (Ch·∫•m t·ª± ƒë·ªông)</h6>
                <div class="mb-3">
                    <input type="file" id="word-upload" accept=".docx" class="d-none" onchange="handleWordUpload(this)">
                    <button onclick="document.getElementById('word-upload').click()" class="btn btn-warning fw-bold">
                        üìÇ Ch·ªçn file Word ƒê√°p √Ån (.docx)
                    </button>
                </div>

                <div class="row g-2 bg-white p-3 border rounded mb-3">
                    <div class="col-md-4"><label>S·ªë c√¢u TN</label><input type="number" id="num-mcq" class="form-control" value="0"></div>
                    <div class="col-md-4"><label>S·ªë c√¢u ƒê/S</label><input type="number" id="num-tf" class="form-control" value="0"></div>
                    <div class="col-md-4"><label>S·ªë c√¢u Ng·∫Øn</label><input type="number" id="num-short" class="form-control" value="0"></div>
                    <div class="col-12 text-end"><button onclick="generateForm()" class="btn btn-secondary mt-2">V·∫Ω Form</button></div>
                </div>
                <div id="answer-area" class="d-none bg-light p-3 border rounded mb-3"></div>

                <button onclick="saveExam()" id="btn-save" class="btn btn-primary w-100 py-3 fw-bold fs-5">L∆ØU ƒê·ªÄ THI</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxgSg9cJxJ9JQsjUo-vgt60GwkUX-PCOgL-oAs_rOxC19AJ4H7ISbai7-0pDgXJraFc7g/exec"; // THAY LINK C·ª¶A B·∫†N
        let answerData = {};

        function toggleChapter() {
            const type = document.getElementById('exam-type').value;
            document.getElementById('div-chapter').style.display = (type === 'tx') ? 'block' : 'none';
        }

        // --- X·ª¨ L√ù WORD (GI·ªÆ NGUY√äN) ---
        function handleWordUpload(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => mammoth.convertToHtml({arrayBuffer:e.target.result}).then(r=>parseDoc(r.value));
            r.readAsArrayBuffer(f);
        }
        function parseDoc(html) {
            const p = new DOMParser(); const doc = p.parseFromString(html,'text/html');
            const txt = doc.body.innerText; const tables = doc.querySelectorAll('table');
            let data = {}, mcq=0, tf=0, sh=0;

            // 1. TN
            let m; const re = /(\d+)[\.\s]*([A-D])/g;
            while((m=re.exec(txt))!==null) { const q=parseInt(m[1]); if(q<100){data[`p1_c${q}`]=m[2]; if(q>mcq)mcq=q;} }

            // 2. Bang
            tables.forEach(t => {
                const trs = t.querySelectorAll('tr'); const tText = t.innerText;
                if(tText.includes("ƒê√∫ng")||tText.includes("Sai")){
                    let colMap={};
                    trs[0].querySelectorAll('td').forEach((td,i)=>{const mx=td.innerText.match(/C√¢u\s*(\d+)/i); if(mx) colMap[i]=parseInt(mx[1])});
                    for(let i=1;i<trs.length;i++){
                        trs[i].querySelectorAll('td').forEach((td,idx)=>{
                            const q=colMap[idx]; if(q){
                                const sub=td.innerText.match(/^([a-d])/i);
                                const val=td.innerText.match(/(ƒê√∫ng|Sai|ƒê|S)/i);
                                if(sub&&val){ data[`p2_c${q}_${sub[1].toLowerCase()}`]=val[1].toUpperCase()[0]=='ƒê'?'D':'S'; if(q>tf)tf=q; }
                            }
                        });
                    }
                }
                if(tText.includes("Ch·ªçn")||tText.includes("ƒê√°p √°n")){
                    let hRow, vRow;
                    trs.forEach(r=>{ if(r.innerText.includes("C√¢u")) hRow=r; if(r.innerText.includes("Ch·ªçn")||r.innerText.includes("ƒê√°p")) vRow=r; });
                    if(hRow&&vRow){
                        const h=hRow.querySelectorAll('td'), v=vRow.querySelectorAll('td');
                        for(let i=0; i<Math.min(h.length,v.length); i++){
                            const q=parseInt(h[i].innerText.replace(/\D/g,''));
                            if(q>0 && q<100){
                                data[`p3_c${q}`]=v[i].innerText.replace(/Ch·ªçn|:|"/g,'').trim();
                                if(q>sh)sh=q;
                            }
                        }
                    }
                }
            });
            
            document.getElementById('num-mcq').value=mcq;
            document.getElementById('num-tf').value=tf;
            document.getElementById('num-short').value=sh;
            answerData = data; generateForm();
        }

        function generateForm() { /* (Gi·ªØ nguy√™n logic v·∫Ω form nh∆∞ c≈©) */ } // B·∫°n d√πng l·∫°i h√†m generateForm c≈© nh√©

        async function saveExam() {
            const btn = document.getElementById('btn-save');
            const id = document.getElementById('exam-id').value;
            const linkExam = document.getElementById('link-exam').value;
            if(!id || !linkExam) return alert("Thi·∫øu M√£ ho·∫∑c Link ƒê·ªÅ!");

            btn.innerText = "ƒêANG L∆ØU..."; btn.disabled = true;
            
            const payload = {
                action: "addExam",
                id: id, title: document.getElementById('exam-title').value,
                pdfLink: linkExam, solLink: document.getElementById('link-sol').value,
                duration: document.getElementById('exam-duration').value,
                isEssay: document.getElementById('is-essay').checked,
                // L∆ØU PH√ÇN LO·∫†I
                classGrade: document.getElementById('exam-class').value,
                examType: document.getElementById('exam-type').value,
                chapter: document.getElementById('exam-type').value === 'tx' ? document.getElementById('exam-chapter').value : "",
                
                totalQuestions: parseInt(document.getElementById('num-mcq').value)+parseInt(document.getElementById('num-tf').value)+parseInt(document.getElementById('num-short').value),
                structure: { config: { mcq: document.getElementById('num-mcq').value, tf: document.getElementById('num-tf').value, short: document.getElementById('num-short').value }, answers: answerData }
            };

            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload), headers: {'Content-Type': 'text/plain'} });
                alert("L∆∞u th√†nh c√¥ng!"); location.reload();
            } catch(e) { alert("L·ªói: "+e); btn.disabled=false; }
        }
    </script>
</body>
</html>