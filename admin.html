<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Quản Trị Hệ Thống</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 80px; }
        
        /* Navbar & Tabs */
        .nav-pills .nav-link { border-radius: 8px; font-weight: 600; color: #555; margin-right: 5px; padding: 10px 15px; cursor: pointer; transition: 0.2s; }
        .nav-pills .nav-link:hover { background-color: #e9ecef; }
        .nav-pills .nav-link.active { background-color: #0d6efd; color: white; box-shadow: 0 4px 6px rgba(13,110,253,0.3); }
        
        /* Cards */
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card-header { border-radius: 12px 12px 0 0 !important; padding: 15px 20px; }
        
        /* Form Elements */
        .form-label { font-weight: 600; font-size: 0.9rem; color: #495057; }
        .form-select, .form-control { border-radius: 8px; padding: 10px; }
        .form-select:focus, .form-control:focus { box-shadow: 0 0 0 3px rgba(13,110,253,0.15); border-color: #0d6efd; }
    </style>

    <script>
        // Kiểm tra đăng nhập
        if (!sessionStorage.getItem("isAdmin")) window.location.href = "login.html";
    </script>
</head>
<body>
    
    <nav class="navbar navbar-dark bg-primary shadow mb-4 sticky-top">
        <div class="container">
            <span class="navbar-brand fw-bold h1 m-0"><i class="bi bi-shield-lock-fill"></i> QUẢN TRỊ VIÊN</span>
            <div class="d-flex gap-2">
                <a href="index.html" class="btn btn-light btn-sm fw-bold text-primary shadow-sm" target="_blank">
                    <i class="bi bi-phone"></i> Xem Giao Diện HS
                </a>
                <button onclick="sessionStorage.clear();location.href='login.html'" class="btn btn-outline-light btn-sm fw-bold">Thoát</button>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-student" data-bs-toggle="pill" data-bs-target="#pills-student" type="button" role="tab">
                    <i class="bi bi-people-fill"></i> 1. Quản Lý Học Sinh
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-exam" data-bs-toggle="pill" data-bs-target="#pills-exam" type="button" role="tab">
                    <i class="bi bi-file-earmark-text-fill"></i> 2. Nhập Đề Thi
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-rank" data-bs-toggle="pill" data-bs-target="#pills-rank" type="button" role="tab">
                    <i class="bi bi-trophy-fill"></i> 3. Kết Quả & Thống Kê
                </button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-student" role="tabpanel" aria-labelledby="tab-student">
                <div class="card border-success">
                    <div class="card-header bg-success text-white fw-bold">
                        <i class="bi bi-file-earmark-spreadsheet-fill"></i> NHẬP DANH SÁCH TỪ EXCEL
                    </div>
                    <div class="card-body">
                        <div class="alert alert-light border-start border-success border-4 mb-3 shadow-sm">
                            <strong><i class="bi bi-lightbulb-fill text-warning"></i> Hướng dẫn:</strong><br>
                            Tạo file Excel (.xlsx) gồm 3 cột theo thứ tự: 
                            <span class="badge bg-secondary">Mã HS</span> 
                            <span class="badge bg-secondary">Họ Tên</span> 
                            <span class="badge bg-secondary">Lớp</span> (VD: 6A, 9B...).<br>
                            <em>Hệ thống sẽ tự động thêm vào database.</em>
                        </div>
                        
                        <div class="input-group mb-3">
                            <input type="file" id="file-student" class="form-control" accept=".xlsx, .xls">
                            <button onclick="importStudents()" id="btn-upload-hs" class="btn btn-success fw-bold px-4">
                                <i class="bi bi-cloud-upload-fill"></i> TẢI LÊN NGAY
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-exam" role="tabpanel" aria-labelledby="tab-exam">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">NHẬP ĐỀ THI MỚI</h5>
                        <button onclick="location.reload()" class="btn btn-sm btn-light text-primary fw-bold rounded-pill px-3">Làm mới</button>
                    </div>
                    <div class="card-body">
                        <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">A. Phân loại & Thông tin chung</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Khối lớp</label>
                                <select id="exam-class" class="form-select bg-light">
                                    <option value="6">Lớp 6</option><option value="7">Lớp 7</option>
                                    <option value="8">Lớp 8</option><option value="9">Lớp 9</option>
                                    <option value="10">Lớp 10</option><option value="11">Lớp 11</option>
                                    <option value="12">Lớp 12</option><option value="TN">Luyện thi THPT</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Loại kỳ thi</label>
                                <select id="exam-type" class="form-select bg-light" onchange="toggleChapter()">
                                    <option value="tx">Thường xuyên</option>
                                    <option value="gk1">Giữa kỳ 1</option><option value="ck1">Cuối kỳ 1</option>
                                    <option value="gk2">Giữa kỳ 2</option><option value="ck2">Cuối kỳ 2</option>
                                </select>
                            </div>
                            <div class="col-md-3" id="div-chapter">
                                <label class="form-label">Chương</label>
                                <select id="exam-chapter" class="form-select bg-light">
                                    <option value="1">Chương 1</option><option value="2">Chương 2</option>
                                    <option value="3">Chương 3</option><option value="4">Chương 4</option>
                                    <option value="5">Chương 5</option><option value="6">Chương 6</option>
                                    <option value="7">Chương 7</option><option value="8">Chương 8</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Thời gian (phút)</label>
                                <input type="number" id="exam-duration" class="form-control" value="90">
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-3"><label class="form-label">Mã Đề (Duy nhất)</label><input type="text" id="exam-id" class="form-control" placeholder="VD: TOAN10-GK1"></div>
                            <div class="col-md-9"><label class="form-label">Tên Đề Thi</label><input type="text" id="exam-title" class="form-control" placeholder="VD: Kiểm tra Giữa kì 1..."></div>
                        </div>

                        <h6 class="text-primary fw-bold border-bottom pb-2 mb-3">B. Link File (Google Drive)</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label text-danger">Link Đề Thi (PDF) *</label>
                                <input type="text" id="link-exam" class="form-control" placeholder="Dán link Drive đề...">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-success">Link Lời Giải (PDF)</label>
                                <input type="text" id="link-sol" class="form-control" placeholder="Dán link Drive giải...">
                            </div>
                            <div class="col-12 mt-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="is-essay">
                                    <label class="form-check-label fw-bold" for="is-essay">Cho phép nộp ảnh Tự luận</label>
                                </div>
                            </div>
                        </div>

                        <h6 class="text-primary fw-bold border-bottom pb-2 mb-3 mt-4">C. Cấu hình Điểm & Đáp án</h6>
                        <div class="row g-3 mb-3 bg-light p-3 rounded border">
                            <div class="col-md-4">
                                <label class="form-label small text-muted">Điểm P1 (Trắc nghiệm)</label>
                                <input type="number" id="score-p1" class="form-control fw-bold text-primary" value="3.0" step="0.1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small text-muted">Điểm P2 (Đúng/Sai)</label>
                                <input type="text" class="form-control text-muted" value="Tự động (0.1 - 1.0)" disabled>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small text-muted">Điểm P3 (Trả lời ngắn)</label>
                                <input type="number" id="score-p3" class="form-control fw-bold text-primary" value="3.0" step="0.1">
                            </div>
                        </div>

                        <div class="mb-3 d-flex gap-2">
                            <input type="file" id="word-upload" accept=".docx" class="d-none" onchange="handleWordUpload(this)">
                            <button onclick="document.getElementById('word-upload').click()" class="btn btn-warning btn-sm fw-bold shadow-sm">
                                <i class="bi bi-file-word"></i> Import Đáp án từ Word
                            </button>
                            <button onclick="generateForm()" class="btn btn-secondary btn-sm fw-bold shadow-sm">
                                <i class="bi bi-pencil"></i> Nhập Tay
                            </button>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-4"><input type="number" id="num-mcq" class="form-control form-control-sm" placeholder="Số câu TN" value="0"></div>
                            <div class="col-4"><input type="number" id="num-tf" class="form-control form-control-sm" placeholder="Số câu Đ/S" value="0"></div>
                            <div class="col-4"><input type="number" id="num-short" class="form-control form-control-sm" placeholder="Số câu Ngắn" value="0"></div>
                        </div>

                        <div id="answer-area" class="d-none bg-white p-3 border rounded mb-3 shadow-sm" style="max-height: 400px; overflow-y: auto;"></div>

                        <button onclick="saveExamFinal()" id="btn-save" class="btn btn-success w-100 py-3 fw-bold fs-5 shadow">
                            <i class="bi bi-cloud-arrow-up-fill"></i> LƯU ĐỀ THI
                        </button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-rank" role="tabpanel" aria-labelledby="tab-rank">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark fw-bold">
                        <i class="bi bi-search"></i> TRA CỨU KẾT QUẢ THI
                    </div>
                    <div class="card-body">
                        
                        <div class="row g-2 mb-3 align-items-end">
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted">1. Chọn Khối</label>
                                <select id="filter-grade" class="form-select" onchange="updateAdminFilters()">
                                    <option value="6">Khối 6</option><option value="7">Khối 7</option>
                                    <option value="8">Khối 8</option><option value="9">Khối 9</option>
                                    <option value="10">Khối 10</option><option value="11">Khối 11</option><option value="12">Khối 12</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted">2. Chọn Lớp</label>
                                <select id="filter-class" class="form-select">
                                    <option value="">Tất cả các lớp</option>
                                    </select>
                            </div>
                            <div class="col-md-4">
                                <label class="small fw-bold text-muted">3. Chọn Đề Thi</label>
                                <select id="filter-exam" class="form-select">
                                    <option value="">Đang tải danh sách đề...</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button onclick="viewRankings()" class="btn btn-primary w-100 fw-bold">XEM</button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle shadow-sm">
                                <thead class="table-dark text-center">
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th>Học Sinh</th>
                                        <th style="width: 100px;">Lớp</th>
                                        <th style="width: 100px;">Điểm</th>
                                        <th style="width: 180px;">Thời gian nộp</th>
                                    </tr>
                                </thead>
                                <tbody id="rank-table-body">
                                    <tr><td colspan="5" class="text-center text-muted py-4">Vui lòng chọn đề thi và bấm XEM</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ============================================================
        // DÁN LINK WEB APP CỦA BẠN VÀO DÒNG DƯỚI ĐÂY
        const API_URL = "https://script.google.com/macros/s/AKfycbxvNZw8PGyVAcLU8Kas8JKvFBh6lcYRKJ05iDw2WUw3KV1bzfMEDPpmBwKrA9U9IFiqsA/exec"; 
        // ============================================================

        let answerData = {};
        let allExamsForAdmin = []; // Cache danh sách đề để lọc

        // --- INIT ---
        window.onload = function() {
            updateAdminFilters(); // Khởi tạo dropdown lớp
            loadExamListForAdmin(); // Tải danh sách đề cho tab thống kê
        }

        function toggleChapter() {
            const type = document.getElementById('exam-type').value;
            document.getElementById('div-chapter').style.display = (type === 'tx') ? 'block' : 'none';
        }

        // --- 1. IMPORT HỌC SINH ---
        function importStudents() {
            const file = document.getElementById('file-student').files[0];
            const btn = document.getElementById('btn-upload-hs');
            
            if(!file) return alert("Vui lòng chọn file Excel!");

            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Đang tải lên...`;
            btn.disabled = true;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.SheetNames[0];
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], {header: 1});
                
                const students = [];
                for(let i=1; i<rows.length; i++) {
                    if(rows[i][0] && rows[i][1]) { 
                        students.push([rows[i][0], rows[i][1], rows[i][2] || ""]);
                    }
                }

                if(students.length === 0) {
                    btn.innerHTML = `<i class="bi bi-cloud-upload-fill"></i> TẢI LÊN NGAY`;
                    btn.disabled = false;
                    return alert("File rỗng hoặc sai định dạng!");
                }

                if(confirm(`Tìm thấy ${students.length} học sinh. Bạn có muốn cập nhật không?`)) {
                    fetch(API_URL, {
                        method: 'POST', headers: {'Content-Type': 'text/plain'},
                        body: JSON.stringify({ action: "importStudents", students: students })
                    })
                    .then(r => r.json())
                    .then(json => {
                        btn.innerHTML = `<i class="bi bi-cloud-upload-fill"></i> TẢI LÊN NGAY`;
                        btn.disabled = false;
                        if(json.success) {
                            alert("✅ Đã cập nhật danh sách thành công!");
                            document.getElementById('file-student').value = ""; 
                        } else alert("Lỗi: " + json.error);
                    })
                    .catch(e => { alert("Lỗi kết nối: " + e); btn.disabled = false; });
                } else {
                    btn.innerHTML = `<i class="bi bi-cloud-upload-fill"></i> TẢI LÊN NGAY`;
                    btn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 2. TRA CỨU RANK (LOGIC MỚI) ---
        
        // Cập nhật danh sách lớp theo khối trong bộ lọc
        function updateAdminFilters() {
            const grade = document.getElementById('filter-grade').value;
            const clsSel = document.getElementById('filter-class');
            clsSel.innerHTML = '<option value="">Tất cả các lớp</option>';
            
            let letters = (grade <= 9) ? ['A','B','C','D','E'] : ['A','B'];
            letters.forEach(L => clsSel.innerHTML += `<option value="${grade}${L}">${grade}${L}</option>`);
            
            filterExamDropdown(); // Lọc lại danh sách đề theo khối mới chọn
        }

        // Tải toàn bộ đề về để lọc
        async function loadExamListForAdmin() {
            try {
                const res = await fetch(API_URL + "?action=getExams&t=" + Date.now());
                const json = await res.json();
                allExamsForAdmin = json.data || [];
                filterExamDropdown();
            } catch(e) { console.error("Lỗi tải đề:", e); }
        }

        // Đổ đề thi vào dropdown dựa trên khối đã chọn
        function filterExamDropdown() {
            const grade = document.getElementById('filter-grade').value;
            const examSel = document.getElementById('filter-exam');
            examSel.innerHTML = '<option value="">-- Chọn Đề --</option>';
            
            const list = allExamsForAdmin.filter(e => e.classGrade == grade);
            if(list.length > 0) {
                list.forEach(e => {
                    examSel.innerHTML += `<option value="${e.id}">${e.title}</option>`;
                });
            } else {
                examSel.innerHTML = '<option value="">Không có đề nào</option>';
            }
        }

        function viewRankings() {
            const maDe = document.getElementById('filter-exam').value;
            const lopFilter = document.getElementById('filter-class').value; // Có thể rỗng
            
            if(!maDe) return alert("Vui lòng chọn một đề thi!");
            
            const tbody = document.getElementById('rank-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary spinner-border-sm"></div> Đang tải dữ liệu...</td></tr>';

            fetch(API_URL + `?action=getRankingsAdmin&maDe=${maDe}`)
            .then(r => r.json())
            .then(json => {
                let list = json.data || [];
                
                // Nếu giáo viên có chọn lớp cụ thể thì lọc thêm (Client-side filtering)
                // Lưu ý: API getRankingsAdmin hiện trả về: maHS, tenHS, diem, time.
                // Để lọc theo lớp chính xác, ta cần thông tin lớp trong kết quả hoặc suy luận từ Mã HS (nếu mã có quy luật).
                // Ở đây tạm thời hiển thị tất cả kết quả của đề đó.
                // Nếu bạn muốn lọc lớp chính xác, cần sửa API để trả về cả cột Lớp.
                
                if(list.length > 0) {
                    tbody.innerHTML = list.map((r, i) => `
                        <tr class="${i<3 ? 'table-warning' : ''}">
                            <td class="text-center fw-bold">${i+1}</td>
                            <td class="fw-bold text-primary">${r.tenHS}</td>
                            <td class="text-center">${r.maHS}</td>
                            <td class="text-center fw-bold fs-5 text-danger">${r.diem}</td>
                            <td class="text-center small text-muted">${r.time}</td>
                        </tr>`).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Chưa có bài làm nào cho đề này!</td></tr>';
                }
            })
            .catch(e => {
                alert("Lỗi tải dữ liệu: " + e);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Lỗi kết nối</td></tr>';
            });
        }

        // --- 3. XỬ LÝ WORD & FORM (GIỮ NGUYÊN) ---
        function handleWordUpload(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => mammoth.convertToHtml({arrayBuffer:e.target.result}).then(r=>parseDoc(r.value));
            r.readAsArrayBuffer(f);
        }
        function parseDoc(html) {
            const p = new DOMParser(); const doc = p.parseFromString(html,'text/html');
            const txt = doc.body.innerText; const tables = doc.querySelectorAll('table');
            let data = {}, mcq=0, tf=0, sh=0;

            const re = /(\d+)[\.\s]*([A-D])/g; let m;
            while((m=re.exec(txt))!==null) { const q=parseInt(m[1]); if(q<100){data[`p1_c${q}`]=m[2]; if(q>mcq)mcq=q;} }

            tables.forEach(t => {
                const trs = t.querySelectorAll('tr'); const tText = t.innerText;
                if(tText.includes("Đúng")||tText.includes("Sai")){
                    let colMap={}; trs[0].querySelectorAll('td').forEach((td,i)=>{ const mx=td.innerText.match(/Câu\s*(\d+)/i); if(mx) colMap[i]=parseInt(mx[1]) });
                    for(let i=1;i<trs.length;i++){
                        trs[i].querySelectorAll('td').forEach((td,idx)=>{
                            const q=colMap[idx]; if(q){
                                const sub=td.innerText.match(/^([a-d])/i); const val=td.innerText.match(/(Đúng|Sai|Đ|S)/i);
                                if(sub&&val){ data[`p2_c${q}_${sub[1].toLowerCase()}`]=val[1].toUpperCase()[0]=='Đ'?'D':'S'; if(q>tf)tf=q; }
                            }
                        });
                    }
                }
                if(tText.includes("Chọn")||tText.includes("Đáp án")){
                    let hRow, vRow; trs.forEach(r=>{ if(r.innerText.includes("Câu")) hRow=r; if(r.innerText.includes("Chọn")||r.innerText.includes("Đáp")) vRow=r; });
                    if(hRow&&vRow){
                        const h=hRow.querySelectorAll('td'), v=vRow.querySelectorAll('td');
                        for(let i=0; i<Math.min(h.length,v.length); i++){
                            const q=parseInt(h[i].innerText.replace(/\D/g,''));
                            if(q>0 && q<100){ data[`p3_c${q}`]=v[i].innerText.replace(/Chọn|:|"/g,'').trim(); if(q>sh)sh=q; }
                        }
                    }
                }
            });
            document.getElementById('num-mcq').value=mcq;
            document.getElementById('num-tf').value=tf;
            document.getElementById('num-short').value=sh;
            answerData = data; generateForm(); fillFormData(data);
            alert(`✅ Đã nhập: ${mcq} TN, ${tf} Đ/S, ${sh} TLN`);
        }

        function generateForm() {
            const mcq = parseInt(document.getElementById('num-mcq').value)||0;
            const tf = parseInt(document.getElementById('num-tf').value)||0;
            const short = parseInt(document.getElementById('num-short').value)||0;
            const div = document.getElementById('answer-area');
            div.innerHTML = ''; div.classList.remove('d-none');

            if(mcq>0) {
                let h = `<h6 class="text-primary small fw-bold">I. TRẮC NGHIỆM</h6><div class="row g-1 mb-3">`;
                for(let i=1; i<=mcq; i++) h += `<div class="col-4 col-md-2"><div class="input-group input-group-sm"><span class="input-group-text">${i}</span><select class="form-select" id="in-p1-${i}" onchange="updKey('p1_c${i}',this.value)"><option value="">-</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div></div>`;
                div.innerHTML += h + '</div>';
            }
            if(tf>0) {
                let h = `<h6 class="text-primary small fw-bold">II. ĐÚNG SAI</h6><div class="row g-2 mb-3">`;
                for(let i=1; i<=tf; i++) {
                    h += `<div class="col-md-6 border rounded p-2 bg-light"><span class="fw-bold me-2 small">Câu ${i}:</span>` + ['a','b','c','d'].map(s=>`<span class="me-1 small">${s})</span><select class="d-inline-block form-select-sm border py-0 px-1 me-2" style="width:45px" id="in-p2-${i}-${s}" onchange="updKey('p2_c${i}_${s}',this.value)"><option value="">-</option><option value="D">Đ</option><option value="S">S</option></select>`).join('') + `</div>`;
                }
                div.innerHTML += h + '</div>';
            }
            if(short>0) {
                let h = `<h6 class="text-primary small fw-bold">III. TRẢ LỜI NGẮN</h6><div class="row g-2">`;
                for(let i=1; i<=short; i++) h+= `<div class="col-6 col-md-3"><div class="input-group input-group-sm"><span class="input-group-text">${i}</span><input type="text" class="form-control" id="in-p3-${i}" onblur="updKey('p3_c${i}',this.value)"></div></div>`;
                div.innerHTML += h + '</div>';
            }
        }
        function fillFormData(data) {
            for(let k in data) {
                let id = "";
                if(k.startsWith("p1")) id = "in-p1-" + k.replace("p1_c", "");
                else if(k.startsWith("p2")) id = "in-p2-" + k.replace("p2_c", "").replace("_", "-");
                else if(k.startsWith("p3")) id = "in-p3-" + k.replace("p3_c", "");
                const el = document.getElementById(id); if(el) el.value = data[k];
            }
        }
        function updKey(k,v) { answerData[k] = v.trim().toUpperCase(); }

        // --- 4. LƯU ĐỀ ---
        async function saveExamFinal() {
            const btn = document.getElementById('btn-save');
            const id = document.getElementById('exam-id').value;
            const linkExam = document.getElementById('link-exam').value;
            if(!id || !linkExam) return alert("Nhập đủ Mã và Link đề!");

            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ĐANG LƯU...`; btn.disabled = true;
            
            const payload = {
                action: "addExam",
                id: id, title: document.getElementById('exam-title').value,
                pdfLink: linkExam, solLink: document.getElementById('link-sol').value,
                duration: document.getElementById('exam-duration').value,
                isEssay: document.getElementById('is-essay').checked,
                classGrade: document.getElementById('exam-class').value,
                examType: document.getElementById('exam-type').value,
                chapter: document.getElementById('exam-type').value === 'tx' ? document.getElementById('exam-chapter').value : "",
                totalQuestions: parseInt(document.getElementById('num-mcq').value)+parseInt(document.getElementById('num-tf').value)+parseInt(document.getElementById('num-short').value),
                structure: {
                    config: {
                        mcq: parseInt(document.getElementById('num-mcq').value)||0,
                        tf: parseInt(document.getElementById('num-tf').value)||0,
                        short: parseInt(document.getElementById('num-short').value)||0,
                        scoreP1: parseFloat(document.getElementById('score-p1').value) || 3.0,
                        scoreP3: parseFloat(document.getElementById('score-p3').value) || 3.0
                    },
                    answers: answerData
                }
            };

            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload), headers: {'Content-Type': 'text/plain'} });
                alert("✅ Lưu đề thi thành công!"); location.reload();
            } catch(e) { alert("Lỗi: "+e); btn.innerHTML = "LƯU LẠI"; btn.disabled=false; }
        }
    </script>
</body>
</html>