<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Quản Trị Hệ Thống</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>body{background:#f0f2f5;padding-bottom:100px}</style>
    <script>if(!sessionStorage.getItem("isAdmin")) window.location.href="login.html";</script>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary shadow mb-4"><div class="container"><span class="navbar-brand fw-bold">QUẢN TRỊ VIÊN</span><a href="index.html" target="_blank" class="btn btn-light btn-sm fw-bold">Về Trang Chủ</a></div></nav>
    <div class="container">
        <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-student">1. Quản Lý HS</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-exam">2. Nhập Đề Thi</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-rank">3. Kết Quả</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="pills-student">
                <div class="card p-3 border-success"><h6 class="fw-bold text-success">IMPORT HỌC SINH TỪ EXCEL</h6><input type="file" id="file-student" class="form-control mb-2"><button onclick="importStudents()" class="btn btn-success">Upload</button></div>
            </div>

            <div class="tab-pane fade" id="pills-exam">
                <div class="card p-4 shadow-sm">
                    <h5 class="fw-bold text-primary border-bottom pb-2 mb-3">NHẬP ĐỀ THI MỚI</h5>
                    <div class="row g-2 mb-3">
                        <div class="col-3">
                            <label class="small fw-bold">Khối/Lớp</label>
                            <select id="exam-class" class="form-select" onchange="updateExamTypes('exam')">
                                <option value="6">Toán 6</option><option value="7">Toán 7</option>
                                <option value="8">Toán 8</option><option value="9">Toán 9</option>
                                <option value="TS10">Tuyển sinh 10</option>
                                <option value="10">Toán 10</option><option value="11">Toán 11</option><option value="12">Toán 12</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <label class="small fw-bold">Loại Đề</label>
                            <select id="exam-type" class="form-select" onchange="toggleChapter()"></select>
                        </div>
                        <div class="col-3" id="div-chapter">
                            <label class="small fw-bold">Chương</label>
                            <select id="exam-chapter" class="form-select"></select>
                        </div>
                        <div class="col-3"><label class="small fw-bold">Phút</label><input type="number" id="exam-duration" class="form-control" value="90"></div>
                    </div>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-3"><input id="exam-id" class="form-control bg-light" placeholder="(Mã tự động)" readonly></div>
                        <div class="col-9"><input id="exam-title" class="form-control" placeholder="Tên Đề Thi"></div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><input id="link-exam" class="form-control" placeholder="Link PDF Đề Bài (Drive)"></div>
                        <div class="col-6"><input id="link-sol" class="form-control" placeholder="Link PDF Lời Giải (Drive)"></div>
                    </div>
                    <div class="col-12 mb-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="is-essay"><label class="form-check-label fw-bold">Cho phép nộp Tự luận</label></div></div>
                    
                    <div class="bg-light p-3 rounded border mb-3">
                        <h6 class="fw-bold text-dark small mb-2">ĐÁP ÁN (Upload Word hoặc Nhập tay)</h6>
                        <div class="input-group mb-2">
                            <input type="file" id="word-upload" class="form-control" accept=".docx" onchange="handleWordUpload(this)">
                            <button class="btn btn-warning fw-bold" disabled>QUÉT FILE</button>
                        </div>
                        
                        <div class="row g-2 align-items-end mt-2">
                            <div class="col-3"><label class="small">TN</label><input type="number" id="num-mcq" class="form-control" value="0"></div>
                            <div class="col-3"><label class="small">Đ/S</label><input type="number" id="num-tf" class="form-control" value="0"></div>
                            <div class="col-3"><label class="small">Ngắn</label><input type="number" id="num-short" class="form-control" value="0"></div>
                            <div class="col-3"><button onclick="generateForm()" class="btn btn-secondary w-100 fw-bold">CHI TIẾT</button></div>
                        </div>
                        <div id="answer-area" class="mt-3 border-top pt-3 d-none" style="max-height:300px; overflow-y:auto;"></div>
                    </div>
                    <button onclick="saveExamFinal()" id="btn-save" class="btn btn-success w-100 py-3 fw-bold shadow">LƯU ĐỀ THI</button>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-rank">
                <div class="card p-3 border-warning">
                    <h6 class="fw-bold text-uppercase">THỐNG KÊ KẾT QUẢ</h6>
                    <div class="row g-2 mb-3">
                        <div class="col-3"><select id="stat-grade" class="form-select" onchange="updateExamTypes('stat')">
                            <option value="6">Toán 6</option><option value="7">Toán 7</option>
                            <option value="8">Toán 8</option><option value="9">Toán 9</option>
                            <option value="TS10">Tuyển sinh 10</option>
                            <option value="10">Toán 10</option><option value="11">Toán 11</option><option value="12">Toán 12</option>
                        </select></div>
                        <div class="col-3"><select id="stat-type" class="form-select" onchange="updateStatExamList()"></select></div>
                        <div class="col-4"><select id="stat-exam" class="form-select"><option value="">-- Chọn Đề --</option></select></div>
                        <div class="col-2"><button onclick="viewRankings()" class="btn btn-primary w-100 btn-sm">Xem</button></div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover small">
                            <thead class="table-dark"><tr><th>#</th><th>Tên HS</th><th>Mã HS</th><th>Điểm</th><th>TG Nộp</th><th>Chi tiết</th></tr></thead>
                            <tbody id="rank-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">CHI TIẾT BÀI LÀM</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="detail-content"></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwPWWfo_xck0SqSOcp5fYp8quRwQcCOoM1MIRZEsINEVXnjA_Ou9yP2Us01StbyEBgyiQ/exec"; 
        
        // DATA CHƯƠNG (Từ file mục lục)
        const CHAPTERS = {
            "6": ["Chương I: Tập hợp các số tự nhiên", "Chương II: Tính chia hết trong tập hợp STN", "Chương III: Số nguyên", "Chương IV: Một số hình phẳng trong thực tiễn", "Chương V: Tính đối xứng của hình phẳng", "Chương VI: Phân số", "Chương VII: Số thập phân", "Chương VIII: Những hình hình học cơ bản", "Chương IX: Dữ liệu và xác suất thực nghiệm"],
            "7": ["Chương I: Số hữu tỉ", "Chương II: Số thực", "Chương III: Góc và đường thẳng song song", "Chương IV: Tam giác bằng nhau", "Chương V: Thu thập và biểu diễn dữ liệu", "Chương VI: Tỉ lệ thức và đại lượng tỉ lệ", "Chương VII: Biểu thức đại số", "Chương VIII: Biến cố và xác suất", "Chương IX: Quan hệ trong tam giác", "Chương X: Một số hình khối trong thực tiễn"],
            "8": ["Chương I: Đa thức", "Chương II: Hằng đẳng thức đáng nhớ", "Chương III: Tứ giác", "Chương IV: Định lí Thalès", "Chương V: Dữ liệu và biểu đồ", "Chương VI: Phân thức đại số", "Chương VII: Phương trình bậc nhất", "Chương VIII: Mở đầu về tính xác suất", "Chương IX: Tam giác đồng dạng", "Chương X: Một số hình khối trong thực tiễn"],
            "9": ["Chương I: Hệ hai phương trình bậc nhất", "Chương II: Phương trình bậc nhất một ẩn", "Chương III: Căn bậc hai và căn bậc ba", "Chương IV: Hệ thức lượng trong tam giác vuông", "Chương V: Đường tròn", "Chương VI: Hàm số y=ax^2", "Chương VII: Tần số và tần số tương đối", "Chương VIII: Xác suất biến cố", "Chương IX: Đường tròn ngoại tiếp/nội tiếp", "Chương X: Một số hình khối trong thực tiễn"]
        };

        let answerData = {}, allExamsForStat = [], currentRankData = [];
        window.onload = async function() { 
            updateExamTypes('exam'); updateExamTypes('stat');
            try { const r=await fetch(API_URL+"?action=getExams&t="+Date.now());const j=await r.json(); allExamsForStat=j.data||[]; updateStatExamList(); } catch(e){} 
        };

        function updateExamTypes(context) {
            const clsId = context === 'exam' ? 'exam-class' : 'stat-grade';
            const typeId = context === 'exam' ? 'exam-type' : 'stat-type';
            const cls = document.getElementById(clsId).value;
            const typeSel = document.getElementById(typeId);
            let html = '';
            
            if (cls === 'TS10') html = `<option value="Lan1">Lần 1</option><option value="Lan2">Lần 2</option><option value="Lan3">Lần 3</option><option value="Lan4">Lần 4</option><option value="Lan5">Lần 5</option>`;
            else if (cls === '12') html = `<option value="tx">Thường xuyên</option><option value="gk1">Giữa kỳ 1</option><option value="ck1">Cuối kỳ 1</option><option value="gk2">Giữa kỳ 2</option><option value="ck2">Cuối kỳ 2</option><option value="tn_thpt">TN THPT</option>`;
            else html = `<option value="tx">Thường xuyên</option><option value="gk1">Giữa kỳ 1</option><option value="ck1">Cuối kỳ 1</option><option value="gk2">Giữa kỳ 2</option><option value="ck2">Cuối kỳ 2</option>`;
            typeSel.innerHTML = html;
            if(context === 'exam') toggleChapter(); else updateStatExamList();
        }

        function toggleChapter() { 
            const t = document.getElementById('exam-type').value; 
            const cls = document.getElementById('exam-class').value;
            const div = document.getElementById('div-chapter');
            const sel = document.getElementById('exam-chapter');
            
            if (t === 'tx') {
                div.style.display = 'block';
                const list = CHAPTERS[cls] || ["Chương 1", "Chương 2", "Chương 3", "Chương 4", "Chương 5", "Chương 6"];
                sel.innerHTML = list.map((c, i) => `<option value="${i+1}">${c}</option>`).join('');
            } else { div.style.display = 'none'; }
        }

        // --- XỬ LÝ WORD (THUẬT TOÁN CAO CẤP) ---
        function handleWordUpload(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                mammoth.convertToHtml({arrayBuffer: event.target.result}).then(function(result) { parseDoc(result.value); });
            };
            reader.readAsArrayBuffer(file);
        }

        function parseDoc(html) {
            const doc = new DOMParser().parseFromString(html,'text/html'); 
            let txt = doc.body.innerText.replace(/,/g, '\n').replace(/\t/g, '\n'); // Tách dấu phẩy
            let mcq=0, tf=0, sh=0; let newData = {};

            // 1. Quét Trắc nghiệm (Dựa trên văn bản)
            const reMCQ = /(\d+)[\.\s:–-]*([A-D])(?![a-z0-9])/gi; 
            let m; while((m=reMCQ.exec(txt))!==null) { 
                const q=parseInt(m[1]); if(q<100){ newData[`p1_c${q}`]=m[2].toUpperCase(); if(q>mcq) mcq=q; } 
            }

            // 2. Quét Bảng (Phân biệt thông minh)
            doc.querySelectorAll('table').forEach(table => {
                const trs = table.querySelectorAll('tr'); const tText = table.innerText;
                
                // A. Đúng Sai
                if(tText.includes("Đúng") || tText.includes("Sai")) {
                    let map={}; let headerRow = trs[0];
                    headerRow.querySelectorAll('td').forEach((td, idx) => { let mt = td.innerText.match(/Câu\s*(\d+)/i); if(mt) map[idx] = parseInt(mt[1]); });
                    for(let i=1; i<trs.length; i++) { trs[i].querySelectorAll('td').forEach((td, idx) => { if(map[idx]) { let sub = td.innerText.match(/^([a-d])/i); let val = td.innerText.match(/(Đúng|Sai|Đ|S)/i); if(sub && val) { let v = val[1].toUpperCase().startsWith('Đ') ? 'D' : 'S'; newData[`p2_c${map[idx]}_${sub[1].toLowerCase()}`] = v; if(map[idx] > tf) tf = map[idx]; } } }); }
                }
                
                // B. Bảng Ngang (Trắc nghiệm HOẶC Trả lời ngắn)
                if(tText.includes("Chọn") || tText.includes("Đáp án")) {
                    let qRow = -1, aRow = -1;
                    for(let i=0; i<trs.length; i++) { 
                        let rTxt = trs[i].innerText.toLowerCase(); 
                        if(rTxt.includes("câu") || rTxt.includes("bài")) qRow = i; 
                        if(rTxt.includes("chọn") || rTxt.includes("đáp")) aRow = i; 
                    }
                    if(qRow !== -1 && aRow !== -1) {
                        let qCells = trs[qRow].querySelectorAll('td'); let aCells = trs[aRow].querySelectorAll('td');
                        let len = Math.min(qCells.length, aCells.length);
                        for(let j=0; j<len; j++) {
                            let qNumText = qCells[j].innerText.replace(/\D/g,'');
                            if(qNumText) {
                                let qNum = parseInt(qNumText);
                                let ans = aCells[j].innerText.replace(/Chọn|Đáp án|:|"/gi, '').trim();
                                if(!isNaN(qNum) && ans !== "") { 
                                    // PHÂN LOẠI: Nếu chỉ 1 chữ cái [A-D] => Là Trắc nghiệm (File 2)
                                    // Nếu là số/chuỗi => Là Trả lời ngắn (File 1)
                                    if(/^[A-D]$/i.test(ans)) {
                                        newData[`p1_c${qNum}`] = ans.toUpperCase();
                                        if(qNum > mcq) mcq = qNum;
                                    } else {
                                        newData[`p3_c${qNum}`] = ans; 
                                        if(qNum > sh) sh = qNum; 
                                    }
                                }
                            }
                        }
                    }
                }
            });

            answerData = { ...answerData, ...newData };
            if(mcq > 0) document.getElementById('num-mcq').value = mcq;
            if(tf > 0) document.getElementById('num-tf').value = tf;
            if(sh > 0) document.getElementById('num-short').value = sh;
            generateForm(); fillFormData(); 
            alert(`✅ Đã nhận diện:\n- TN: ${mcq}\n- Đ/S: ${tf}\n- TLN: ${sh}`);
        }

        // (Các hàm generateForm, fillFormData, importStudents... giữ nguyên)
        function generateForm() { const mcq=parseInt(document.getElementById('num-mcq').value)||0, tf=parseInt(document.getElementById('num-tf').value)||0, sh=parseInt(document.getElementById('num-short').value)||0; const div = document.getElementById('answer-area'); div.innerHTML=''; div.classList.remove('d-none'); if(mcq>0) { let h=`<h6 class="text-primary small fw-bold">I. TRẮC NGHIỆM</h6><div class="row g-1 mb-2">`; for(let i=1;i<=mcq;i++) h+=`<div class="col-3 col-md-2"><div class="input-group input-group-sm"><span class="input-group-text">${i}</span><select class="form-select px-1" id="in-p1-${i}" onchange="updKey('p1_c${i}',this.value)"><option>-</option><option>A</option><option>B</option><option>C</option><option>D</option></select></div></div>`; div.innerHTML+=h+'</div>'; } if(tf>0) { let h=`<h6 class="text-primary small fw-bold">II. ĐÚNG SAI</h6><div class="row g-2 mb-2">`; for(let i=1;i<=tf;i++) h+=`<div class="col-md-6 border rounded p-1 bg-light d-flex align-items-center"><span class="small fw-bold me-2">C${i}:</span>`+['a','b','c','d'].map(s=>`<span class="small ms-1">${s})</span><select class="form-select-sm border py-0 px-0 ms-1" style="width:35px" id="in-p2-${i}-${s}" onchange="updKey('p2_c${i}_${s}',this.value)"><option>-</option><option value="D">Đ</option><option value="S">S</option></select>`).join('')+`</div>`; div.innerHTML+=h+'</div>'; } if(sh>0) { let h=`<h6 class="text-primary small fw-bold">III. TRẢ LỜI NGẮN</h6><div class="row g-2">`; for(let i=1;i<=sh;i++) h+=`<div class="col-6 col-md-3"><div class="input-group input-group-sm"><span class="input-group-text fw-bold">C${i}</span><input type="text" class="form-control fw-bold text-primary" id="in-p3-${i}" onblur="updKey('p3_c${i}',this.value)"></div></div>`; div.innerHTML+=h+'</div>'; } }
        function fillFormData() { for(let k in answerData) { let id = k.startsWith("p1")?"in-p1-"+k.replace("p1_c","") : (k.startsWith("p2")?"in-p2-"+k.replace("p2_c","").replace("_","-") : "in-p3-"+k.replace("p3_c","")); let el=document.getElementById(id); if(el) el.value=answerData[k]; } }
        function updKey(k,v) { answerData[k]=v.trim().toUpperCase(); }
        function importStudents() { const f=document.getElementById('file-student').files[0];if(!f)return alert("Chọn file!");const r=new FileReader();r.onload=e=>{const w=XLSX.read(new Uint8Array(e.target.result),{type:'array'});const d=XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]],{header:1});const s=[];for(let i=1;i<d.length;i++)if(d[i][0])s.push([d[i][0],d[i][1],d[i][2]||""]);fetch(API_URL,{method:'POST',body:JSON.stringify({action:"importStudents",students:s})}).then(r=>r.json()).then(j=>{alert("OK")})};r.readAsArrayBuffer(f); }
        function updateStatExamList() { const g=document.getElementById('stat-grade').value, t=document.getElementById('stat-type').value, s=document.getElementById('stat-exam'); s.innerHTML='<option value="">--Chọn--</option>'; allExamsForStat.filter(e=>e.classGrade==g&&e.examType==t).forEach(e=>s.innerHTML+=`<option value="${e.id}">${e.title}</option>`); }
        
        // --- XEM KẾT QUẢ & CHI TIẾT ---
        function viewRankings() { 
            const m=document.getElementById('stat-exam').value; if(!m)return alert("Chọn đề!"); 
            const b=document.getElementById('rank-table-body'); b.innerHTML='<tr><td colspan="6">Đang tải...</td></tr>'; 
            fetch(API_URL+`?action=getRankingsAdmin&maDe=${m}`).then(r=>r.json()).then(j=>{
                currentRankData = j.data || [];
                b.innerHTML = currentRankData.map((r,i) => `<tr><td>${i+1}</td><td>${r.tenHS}</td><td>${r.maHS}</td><td class="fw-bold text-danger">${r.diem}</td><td>${r.time}</td><td><button class="btn btn-sm btn-info text-white" onclick="showDetail(${i})">Chi tiết</button></td></tr>`).join('') || '<tr><td colspan="6">Chưa có dữ liệu</td></tr>';
            }); 
        }
        function showDetail(i) {
            const r = currentRankData[i]; const exam = allExamsForStat.find(e=>e.id==document.getElementById('stat-exam').value);
            const userAns = JSON.parse(r.answers||'{}'); const key = exam.structure.answers; const cfg = exam.structure.config;
            let h = `<h6 class="text-primary fw-bold">${r.tenHS} - ${r.diem} điểm</h6>`;
            if(cfg.mcq>0) { h+=`<div class="fw-bold mt-2">I. TN</div><div class="d-flex flex-wrap gap-2">`; for(let j=1;j<=cfg.mcq;j++) { let u=userAns[`p1_c${j}`]||'', k=key[`p1_c${j}`], c=(u==k)?'bg-success text-white':'bg-danger text-white'; h+=`<div class="border px-2 ${c}">${j}.${u}</div>`; } h+='</div>'; }
            if(cfg.tf>0) { h+=`<div class="fw-bold mt-2">II. Đ/S</div>`; for(let j=1;j<=cfg.tf;j++) { h+=`<div>C${j}: `; ['a','b','c','d'].forEach(s=>{ let u=userAns[`p2_c${j}_${s}`], k=key[`p2_c${j}_${s}`], c=(u==k)?'text-success':'text-danger'; h+=`<span class="fw-bold ${c} me-2">${s})${u=='D'?'Đ':(u=='S'?'S':'-')}</span>`; }); h+='</div>'; } }
            if(cfg.short>0) { h+=`<div class="fw-bold mt-2">III. TLN</div><div class="d-flex flex-wrap gap-2">`; for(let j=1;j<=cfg.short;j++) { let u=userAns[`p3_c${j}`]||'', k=key[`p3_c${j}`], c=(u.trim()==k.trim()&&u!="")?'bg-success text-white':'bg-danger text-white'; h+=`<div class="border px-2 ${c}">${j}. ${u} (${k})</div>`; } h+='</div>'; }
            document.getElementById('detail-content').innerHTML = h; new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        async function saveExamFinal() { const btn = document.getElementById('btn-save'); btn.innerText = "Đang lưu..."; btn.disabled = true; const autoID = 'DE-' + Date.now(); const payload = { action: "addExam", id: autoID, title: document.getElementById('exam-title').value, pdfLink: document.getElementById('link-exam').value, solLink: document.getElementById('link-sol').value, duration: document.getElementById('exam-duration').value, isEssay: document.getElementById('is-essay').checked, classGrade: document.getElementById('exam-class').value, examType: document.getElementById('exam-type').value, chapter: document.getElementById('exam-chapter').value, totalQuestions: parseInt(document.getElementById('num-mcq').value)+parseInt(document.getElementById('num-tf').value)+parseInt(document.getElementById('num-short').value), structure: { config: { mcq: parseInt(document.getElementById('num-mcq').value)||0, tf: parseInt(document.getElementById('num-tf').value)||0, short: parseInt(document.getElementById('num-short').value)||0, scoreP1: 3.0, scoreP3: 3.0 }, answers: answerData } }; try { await fetch(API_URL, {method:'POST', body:JSON.stringify(payload)}); alert("Thành công!"); location.reload(); } catch(e) { alert("Lỗi"); btn.disabled=false; } }
    </script>
</body>
</html>