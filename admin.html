<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Qu·∫£n Tr·ªã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>body{background:#f0f2f5;padding-bottom:80px}</style>
    <script>if(!sessionStorage.getItem("isAdmin")) window.location.href="login.html";</script>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4 shadow"><div class="container"><span class="navbar-brand fw-bold">QU·∫¢N TR·ªä VI√äN</span><a href="index.html" target="_blank" class="btn btn-light btn-sm fw-bold">Xem HS</a></div></nav>
    <div class="container">
        <ul class="nav nav-pills mb-4 bg-white p-2 rounded shadow-sm" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-student">1. Qu·∫£n L√Ω HS</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-exam">2. Nh·∫≠p ƒê·ªÅ Thi</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-rank">3. K·∫øt Qu·∫£</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="pills-student">
                <div class="card p-3 border-success">
                    <h6 class="fw-bold text-success">NH·∫¨P DANH S√ÅCH T·ª™ EXCEL</h6>
                    <input type="file" id="file-student" class="form-control mb-2">
                    <button onclick="importStudents()" class="btn btn-success">Upload</button>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-exam">
                <div class="card p-4 shadow-sm">
                    <h5 class="fw-bold text-primary border-bottom pb-2 mb-3">NH·∫¨P ƒê·ªÄ THI M·ªöI</h5>
                    <div class="row g-2 mb-3">
                        <div class="col-3"><select id="exam-class" class="form-select"><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option></select></div>
                        <div class="col-3"><select id="exam-type" class="form-select" onchange="toggleChapter()"><option value="tx">TX</option><option value="gk1">GK1</option><option value="ck1">CK1</option><option value="gk2">GK2</option><option value="ck2">CK2</option></select></div>
                        <div class="col-3" id="div-chapter"><select id="exam-chapter" class="form-select"><option value="1">C1</option><option value="2">C2</option><option value="3">C3</option><option value="4">C4</option></select></div>
                        <div class="col-3"><input type="number" id="exam-duration" class="form-control" value="90" placeholder="Ph√∫t"></div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-3"><input type="text" id="exam-id" class="form-control" placeholder="M√£ ƒê·ªÅ"></div>
                        <div class="col-9"><input type="text" id="exam-title" class="form-control" placeholder="T√™n ƒê·ªÅ Thi"></div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><input type="text" id="link-exam" class="form-control" placeholder="Link ƒê·ªÅ (PDF)"></div>
                        <div class="col-6"><input type="text" id="link-sol" class="form-control" placeholder="Link Gi·∫£i (PDF)"></div>
                        <div class="col-12 mt-1"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="is-essay"><label class="form-check-label fw-bold">Cho ph√©p n·ªôp T·ª± lu·∫≠n</label></div></div>
                    </div>

                    <div class="bg-light p-3 rounded border mb-3">
                        <h6 class="fw-bold text-dark small mb-2">ƒê√ÅP √ÅN (Import Word ho·∫∑c Nh·∫≠p tay)</h6>
                        <div class="d-flex gap-2 mb-2">
                            <input type="file" id="word-upload" accept=".docx" class="d-none" onchange="handleWordUpload(this)">
                            <button onclick="document.getElementById('word-upload').click()" class="btn btn-warning btn-sm fw-bold">üìÇ Ch·ªçn File ƒê√°p √Ån (.docx)</button>
                            <span class="text-muted small align-self-center">H·ªó tr·ª£ b·∫£ng ngang (C√¢u/Ch·ªçn)</span>
                        </div>
                        <div class="row g-2 align-items-end">
                            <div class="col-3"><label class="small">S·ªë c√¢u TN</label><input type="number" id="num-mcq" class="form-control" value="0"></div>
                            <div class="col-3"><label class="small">S·ªë c√¢u ƒê/S</label><input type="number" id="num-tf" class="form-control" value="0"></div>
                            <div class="col-3"><label class="small">S·ªë c√¢u Ng·∫Øn</label><input type="number" id="num-short" class="form-control" value="0"></div>
                            <div class="col-3"><button onclick="generateForm()" class="btn btn-secondary w-100 fw-bold">HI·ªÜN FORM</button></div>
                        </div>
                        <div id="answer-area" class="mt-3 border-top pt-3 d-none" style="max-height:300px; overflow-y:auto;"></div>
                    </div>

                    <button onclick="saveExamFinal()" id="btn-save" class="btn btn-success w-100 py-3 fw-bold shadow">L∆ØU ƒê·ªÄ THI</button>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-rank">
                <div class="card p-3 border-warning">
                    <h6 class="fw-bold">XEM K·∫æT QU·∫¢</h6>
                    <div class="row g-2 mb-3">
                        <div class="col-3"><select id="stat-grade" class="form-select" onchange="updateStatExamList()"><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option></select></div>
                        <div class="col-3"><select id="stat-type" class="form-select" onchange="updateStatExamList()"><option value="tx">TX</option><option value="gk1">GK1</option></select></div>
                        <div class="col-4"><select id="stat-exam" class="form-select"><option value="">-- Ch·ªçn ƒê·ªÅ --</option></select></div>
                        <div class="col-2"><button onclick="viewRankings()" class="btn btn-primary w-100 btn-sm">Xem</button></div>
                    </div>
                    <div class="table-responsive"><table class="table table-bordered small"><thead class="table-dark"><tr><th>#</th><th>T√™n</th><th>M√£</th><th>ƒêi·ªÉm</th><th>TG</th></tr></thead><tbody id="rank-table-body"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ===========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbyUE1yDW2-NO_B8snzw0Z0PPYa4GCZBox09kJeLLWxEYRpqp8EazFZBWyQ1h6b3uHFHKg/exec"; // THAY LINK C·ª¶A B·∫†N
        // ===========================================

        let answerData = {}, allExamsForStat = [];
        window.onload = async function() { try { const r=await fetch(API_URL+"?action=getExams&t="+Date.now());const j=await r.json(); allExamsForStat=j.data||[]; updateStatExamList(); } catch(e){} };
        function toggleChapter() { document.getElementById('div-chapter').style.display = document.getElementById('exam-type').value === 'tx' ? 'block' : 'none'; }

        // --- X·ª¨ L√ù WORD M·ªöI (UPDATE LOGIC) ---
        function handleWordUpload(inp){ const f=inp.files[0]; if(f){ const r=new FileReader(); r.onload=e=>mammoth.convertToHtml({arrayBuffer:e.target.result}).then(r=>parseDoc(r.value)); r.readAsArrayBuffer(f); } }
        
        function parseDoc(html) {
            const doc = new DOMParser().parseFromString(html,'text/html');
            const txt = doc.body.innerText;
            let data = {}, mcq=0, tf=0, sh=0;

            // 1. Qu√©t Tr·∫Øc nghi·ªám (Regex: 1.A, 1. A, 1: A)
            let m; const reMCQ = /(\d+)[\.\s:]*([A-D])(?!\w)/gi;
            while((m=reMCQ.exec(txt))!==null) { const q=parseInt(m[1]); if(q<100){data[`p1_c${q}`]=m[2].toUpperCase(); if(q>mcq)mcq=q;} }

            // 2. Qu√©t B·∫£ng (ƒê√∫ng Sai & Tr·∫£ l·ªùi ng·∫Øn)
            doc.querySelectorAll('table').forEach(t => {
                const trs = t.querySelectorAll('tr'); 
                const tText = t.innerText;

                // A. ƒê√∫ng Sai (T√¨m c√°c d√≤ng a) ƒê√∫ng...)
                if(tText.includes("ƒê√∫ng") || tText.includes("Sai")) {
                    let map={}; // Map c·ªôt n√†o l√† c√¢u n√†o (D·ª±a v√†o header)
                    // T√¨m header (C√¢u 1, C√¢u 2...)
                    let headerRow = trs[0];
                    headerRow.querySelectorAll('td').forEach((td, idx) => {
                        let mt = td.innerText.match(/C√¢u\s*(\d+)/i);
                        if(mt) map[idx] = parseInt(mt[1]);
                    });

                    // Duy·ªát c√°c d√≤ng d∆∞·ªõi
                    for(let i=1; i<trs.length; i++) {
                        trs[i].querySelectorAll('td').forEach((td, idx) => {
                            if(map[idx]) { // N·∫øu c·ªôt n√†y thu·ªôc v·ªÅ c√¢u h·ªèi map[idx]
                                let sub = td.innerText.match(/^([a-d])/i); // T√¨m a,b,c,d
                                let val = td.innerText.match(/(ƒê√∫ng|Sai|ƒê|S)/i); // T√¨m gi√° tr·ªã
                                if(sub && val) {
                                    let v = val[1].toUpperCase().startsWith('ƒê') ? 'D' : 'S';
                                    data[`p2_c${map[idx]}_${sub[1].toLowerCase()}`] = v;
                                    if(map[idx] > tf) tf = map[idx];
                                }
                            }
                        });
                    }
                }

                // B. Tr·∫£ l·ªùi ng·∫Øn (T√¨m b·∫£ng ngang: C√¢u | 1 | 2... v√† Ch·ªçn | ƒê√°p √°n...)
                // Logic: T√¨m d√≤ng ch·ª©a s·ªë c√¢u, d√≤ng ti·∫øp theo ch·ª©a ƒë√°p √°n
                if(tText.includes("Ch·ªçn") || tText.includes("ƒê√°p √°n") || tText.includes("K·∫øt qu·∫£")) {
                    let qRow = -1, aRow = -1;
                    
                    // T√¨m d√≤ng ch·ª©a "C√¢u" v√† d√≤ng ch·ª©a "Ch·ªçn/ƒê√°p √°n"
                    for(let i=0; i<trs.length; i++) {
                        let rowText = trs[i].innerText.toLowerCase();
                        if(rowText.includes("c√¢u") || rowText.includes("b√†i")) qRow = i;
                        if(rowText.includes("ch·ªçn") || rowText.includes("ƒë√°p √°n") || rowText.includes("k·∫øt qu·∫£")) aRow = i;
                    }

                    // N·∫øu t√¨m th·∫•y c·∫£ 2 d√≤ng
                    if(qRow !== -1 && aRow !== -1) {
                        let qCells = trs[qRow].querySelectorAll('td');
                        let aCells = trs[aRow].querySelectorAll('td');
                        
                        // Duy·ªát t·ª´ng c·ªôt
                        let maxLen = Math.min(qCells.length, aCells.length);
                        for(let j=0; j<maxLen; j++) {
                            // L·∫•y s·ªë c√¢u (b·ªè ch·ªØ 'C√¢u')
                            let qNum = parseInt(qCells[j].innerText.replace(/\D/g,''));
                            // L·∫•y ƒë√°p √°n (b·ªè ch·ªØ 'Ch·ªçn')
                            let ans = aCells[j].innerText.replace(/Ch·ªçn|ƒê√°p √°n|:|"/gi, '').trim();
                            
                            if(!isNaN(qNum) && ans !== "") {
                                data[`p3_c${qNum}`] = ans;
                                if(qNum > sh) sh = qNum;
                            }
                        }
                    }
                }
            });

            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng v√† v·∫Ω form
            document.getElementById('num-mcq').value = mcq;
            document.getElementById('num-tf').value = tf;
            document.getElementById('num-short').value = sh;
            answerData = data; 
            generateForm(); 
            fillFormData(data);
            alert(`‚úÖ ƒê√£ ƒë·ªçc: ${mcq} TN, ${tf} ƒê/S, ${sh} TLN. H√£y ki·ªÉm tra l·∫°i!`);
        }

        function generateForm() {
            const mcq=parseInt(document.getElementById('num-mcq').value)||0, tf=parseInt(document.getElementById('num-tf').value)||0, sh=parseInt(document.getElementById('num-short').value)||0;
            const div = document.getElementById('answer-area'); div.innerHTML=''; div.classList.remove('d-none');
            if(mcq>0) {
                let h=`<h6 class="text-primary small fw-bold">I. TR·∫ÆC NGHI·ªÜM</h6><div class="row g-1 mb-2">`;
                for(let i=1;i<=mcq;i++) h+=`<div class="col-3 col-md-2"><div class="input-group input-group-sm"><span class="input-group-text">${i}</span><select class="form-select px-1" id="in-p1-${i}" onchange="updKey('p1_c${i}',this.value)"><option>-</option><option>A</option><option>B</option><option>C</option><option>D</option></select></div></div>`;
                div.innerHTML+=h+'</div>';
            }
            if(tf>0) {
                let h=`<h6 class="text-primary small fw-bold">II. ƒê√öNG SAI</h6><div class="row g-2 mb-2">`;
                for(let i=1;i<=tf;i++) h+=`<div class="col-md-6 border rounded p-1 bg-light d-flex align-items-center"><span class="small fw-bold me-2">C${i}:</span>`+['a','b','c','d'].map(s=>`<span class="small ms-1">${s})</span><select class="form-select-sm border py-0 px-0 ms-1" style="width:35px" id="in-p2-${i}-${s}" onchange="updKey('p2_c${i}_${s}',this.value)"><option>-</option><option value="D">ƒê</option><option value="S">S</option></select>`).join('')+`</div>`;
                div.innerHTML+=h+'</div>';
            }
            if(sh>0) {
                let h=`<h6 class="text-primary small fw-bold">III. TR·∫¢ L·ªúI NG·∫ÆN</h6><div class="row g-2">`;
                for(let i=1;i<=sh;i++) h+=`<div class="col-6 col-md-3"><div class="input-group input-group-sm"><span class="input-group-text fw-bold">C${i}</span><input type="text" class="form-control fw-bold text-primary" id="in-p3-${i}" onblur="updKey('p3_c${i}',this.value)"></div></div>`;
                div.innerHTML+=h+'</div>';
            }
        }
        function fillFormData(d) { for(let k in d) { let id = k.startsWith("p1")?"in-p1-"+k.replace("p1_c","") : (k.startsWith("p2")?"in-p2-"+k.replace("p2_c","").replace("_","-") : "in-p3-"+k.replace("p3_c","")); let el=document.getElementById(id); if(el) el.value=d[k]; } }
        function updKey(k,v) { answerData[k]=v.trim().toUpperCase(); }
        // C√°c h√†m ph·ª• (importStudents, updateStatExamList, viewRankings, saveExamFinal) gi·ªØ nguy√™n nh∆∞ c≈©
        function importStudents() { const f=document.getElementById('file-student').files[0];if(!f)return alert("Ch·ªçn file!");const r=new FileReader();r.onload=e=>{const w=XLSX.read(new Uint8Array(e.target.result),{type:'array'});const d=XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]],{header:1});const s=[];for(let i=1;i<d.length;i++)if(d[i][0])s.push([d[i][0],d[i][1],d[i][2]||""]);if(confirm(`T·∫£i ${s.length} HS?`))fetch(API_URL,{method:'POST',body:JSON.stringify({action:"importStudents",students:s})}).then(r=>r.json()).then(j=>{alert("OK");location.reload()})};r.readAsArrayBuffer(f); }
        function updateStatExamList() { const g=document.getElementById('stat-grade').value, t=document.getElementById('stat-type').value, s=document.getElementById('stat-exam'); s.innerHTML='<option value="">--Ch·ªçn--</option>'; allExamsForStat.filter(e=>e.classGrade==g&&e.examType==t).forEach(e=>s.innerHTML+=`<option value="${e.id}">${e.title}</option>`); }
        function viewRankings() { const m=document.getElementById('stat-exam').value; if(!m)return alert("Ch·ªçn ƒë·ªÅ!"); const b=document.getElementById('rank-table-body'); b.innerHTML='<tr><td colspan="5">ƒêang t·∫£i...</td></tr>'; fetch(API_URL+`?action=getRankingsAdmin&maDe=${m}`).then(r=>r.json()).then(j=>{b.innerHTML=(j.data||[]).map((r,i)=>`<tr><td>${i+1}</td><td>${r.tenHS}</td><td>${r.maHS}</td><td class="fw-bold text-danger">${r.diem}</td><td>${r.time}</td></tr>`).join('')||'<tr><td colspan="5">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'}); }
        async function saveExamFinal() { const btn = document.getElementById('btn-save'); btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true; const payload = { action: "addExam", id: document.getElementById('exam-id').value, title: document.getElementById('exam-title').value, pdfLink: document.getElementById('link-exam').value, solLink: document.getElementById('link-sol').value, duration: document.getElementById('exam-duration').value, isEssay: document.getElementById('is-essay').checked, classGrade: document.getElementById('exam-class').value, examType: document.getElementById('exam-type').value, chapter: document.getElementById('exam-type').value==='tx' ? document.getElementById('exam-chapter').value : "", totalQuestions: parseInt(document.getElementById('num-mcq').value)+parseInt(document.getElementById('num-tf').value)+parseInt(document.getElementById('num-short').value), structure: { config: { mcq: parseInt(document.getElementById('num-mcq').value)||0, tf: parseInt(document.getElementById('num-tf').value)||0, short: parseInt(document.getElementById('num-short').value)||0, scoreP1: 3.0, scoreP3: 3.0 }, answers: answerData } }; try { await fetch(API_URL, {method:'POST', body:JSON.stringify(payload)}); alert("Th√†nh c√¥ng!"); location.reload(); } catch(e) { alert("L·ªói"); btn.disabled=false; } }
    </script>
</body>
</html>